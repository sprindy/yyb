<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>nRF51822 Beacon Firmware Documentation: nrf51_beacon/ble_app_beacon_dfu/bootloader/main.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF51822 Beacon Firmware Documentation
   &#160;<span id="projectnumber">v1.1.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dfu_2bootloader_2main_8c_source.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">main.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="dfu_2bootloader_2main_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* Copyright (c) 2013 Nordic Semiconductor. All Rights Reserved.</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * The information contained herein is property of Nordic Semiconductor ASA.</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * Terms and conditions of usage are described in detail in NORDIC</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * SEMICONDUCTOR STANDARD SOFTWARE LICENSE AGREEMENT.</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * Licensees are granted free, non-transferable use of the information. NO</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * WARRANTY of ANY KIND is provided. This heading must NOT be removed from</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * the file.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="dfu__transport_8h.html">dfu_transport.h</a>&quot;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="bootloader_8h.html">bootloader.h</a>&quot;</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="bootloader__util_8h.html">bootloader_util.h</a>&quot;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &lt;stddef.h&gt;</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &quot;nordic_common.h&quot;</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="nrf_8h.html">nrf.h</a>&quot;</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="nrf__soc_8h.html">nrf_soc.h</a>&quot;</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &quot;app_error.h&quot;</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="nrf__gpio_8h.html">nrf_gpio.h</a>&quot;</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="nrf51__bitfields_8h.html">nrf51_bitfields.h</a>&quot;</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="ble_8h.html">ble.h</a>&quot;</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="nrf51_8h.html" title="CMSIS Cortex-M0 Peripheral Access Layer Header File for nRF51 from Nordic Semiconductor. ">nrf51.h</a>&quot;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="ble__hci_8h.html">ble_hci.h</a>&quot;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="app__scheduler_8h.html">app_scheduler.h</a>&quot;</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="app__timer_8h.html">app_timer.h</a>&quot;</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="nrf__error_8h.html">nrf_error.h</a>&quot;</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#include &quot;bsp.h&quot;</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="softdevice__handler_8h.html">softdevice_handler.h</a>&quot;</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &quot;pstorage_platform.h&quot;</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="nrf__mbr_8h.html">nrf_mbr.h</a>&quot;</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="led__softblink_8h.html">led_softblink.h</a>&quot;</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga3b95cf3b83cc132e0336162d25dd50f0">   54</a></span>&#160;<span class="preprocessor">#define LED_R_MSK                             (1UL &lt;&lt; LED_RGB_RED)                              </span></div>
<div class="line"><a name="l00055"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga83e38b9ed71136a5b0554e3e7f166f59">   55</a></span>&#160;<span class="preprocessor">#define LED_G_MSK                             (1UL &lt;&lt; LED_RGB_GREEN)                            </span></div>
<div class="line"><a name="l00056"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#gae1bc05d11c797a774394473305fc7f49">   56</a></span>&#160;<span class="preprocessor">#define LED_B_MSK                             (1UL &lt;&lt; LED_RGB_BLUE)                             </span></div>
<div class="line"><a name="l00058"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#gac0ad4bcfe8e9edf6794e9a796378978a">   58</a></span>&#160;<span class="preprocessor">#define IS_SRVC_CHANGED_CHARACT_PRESENT 1                                                       </span></div>
<div class="line"><a name="l00060"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga7556c95f108bb35fc78fa4b0c4cd4ee5">   60</a></span>&#160;<span class="preprocessor">#define BOOTLOADER_BUTTON               BUTTON_0                                                </span></div>
<div class="line"><a name="l00061"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga27fae3b4fea5c7fcc6ed9bde86186f9a">   61</a></span>&#160;<span class="preprocessor">#define UPDATE_IN_PROGRESS_LED_MSK      (LED_B_MSK)                                             </span></div>
<div class="line"><a name="l00063"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga7bbff5bb0ca047b109e70a831f08e217">   63</a></span>&#160;<span class="preprocessor">#define APP_TIMER_PRESCALER             0                                                       </span></div>
<div class="line"><a name="l00064"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#gad5accf4f59399fd2dd980e1569deac3e">   64</a></span>&#160;<span class="preprocessor">#define APP_TIMER_MAX_TIMERS            4                                                       </span></div>
<div class="line"><a name="l00065"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga756f526e607f350705dc7a2e05027cf2">   65</a></span>&#160;<span class="preprocessor">#define APP_TIMER_OP_QUEUE_SIZE         5                                                       </span></div>
<div class="line"><a name="l00067"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#gaa2008f97369b7247def4cf268d36915c">   67</a></span>&#160;<span class="preprocessor">#define BUTTON_DETECTION_DELAY          APP_TIMER_TICKS(50, APP_TIMER_PRESCALER)                </span></div>
<div class="line"><a name="l00069"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga069424fae4e23886ab0a3d0cec3f6980">   69</a></span>&#160;<span class="preprocessor">#define SCHED_MAX_EVENT_DATA_SIZE       MAX(APP_TIMER_SCHED_EVT_SIZE, 0)                        </span></div>
<div class="line"><a name="l00071"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga473fb7cfbf660e0bbe6e4b8d8153e7bc">   71</a></span>&#160;<span class="preprocessor">#define SCHED_QUEUE_SIZE                20                                                      </span></div>
<div class="line"><a name="l00085"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga4df3b6dd09cac7a9c1705e80fcb735cb">   85</a></span>&#160;<span class="preprocessor">void assert_nrf_callback(uint16_t line_num, const uint8_t * p_file_name)</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="preprocessor"></span>{</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <a class="code" href="group__ble__app__beacon__main.html#gad8b5b293dfa06cbbfeb03aaaaa2772cf" title="Function for error handling, which is called when an error has occurred. ">app_error_handler</a>(0xDEADBEEF, line_num, p_file_name);</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;}</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga0892e076b365fc49b55bd0f90ab09222">   93</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__ble__app__bootloader__main.html#ga0892e076b365fc49b55bd0f90ab09222" title="Function for initialization of LEDs. ">leds_init</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;{   </div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    uint32_t             err_code;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <a class="code" href="structled__sb__init__params__t.html">led_sb_init_params_t</a> led_sb_init_params;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    </div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <a class="code" href="group__nrf__gpio.html#ga0271806dc37bffea02d199474d526a35" title="Function for configuring the given GPIO pin number as output with given initial value set...">nrf_gpio_cfg_output</a>(LED_RGB_RED);</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <a class="code" href="group__nrf__gpio.html#ga0271806dc37bffea02d199474d526a35" title="Function for configuring the given GPIO pin number as output with given initial value set...">nrf_gpio_cfg_output</a>(LED_RGB_GREEN);</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <a class="code" href="group__nrf__gpio.html#ga0271806dc37bffea02d199474d526a35" title="Function for configuring the given GPIO pin number as output with given initial value set...">nrf_gpio_cfg_output</a>(LED_RGB_BLUE);</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    </div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <a class="code" href="group__nrf__gpio.html#gacaf7e8e242a47f7b635bbeca5c5934a3" title="Function for setting a GPIO pin. ">nrf_gpio_pin_set</a>(LED_RGB_RED);</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <a class="code" href="group__nrf__gpio.html#gacaf7e8e242a47f7b635bbeca5c5934a3" title="Function for setting a GPIO pin. ">nrf_gpio_pin_set</a>(LED_RGB_GREEN);</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <a class="code" href="group__nrf__gpio.html#gacaf7e8e242a47f7b635bbeca5c5934a3" title="Function for setting a GPIO pin. ">nrf_gpio_pin_set</a>(LED_RGB_BLUE);    </div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    </div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    led_sb_init_params.<a class="code" href="structled__sb__init__params__t.html#af192a7d8766db12b0186d692063685d9">active_high</a>     = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    led_sb_init_params.<a class="code" href="structled__sb__init__params__t.html#a78611e3016d5a4775f5e4a904edb6bf4">duty_cycle_max</a>  = 20;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    led_sb_init_params.<a class="code" href="structled__sb__init__params__t.html#aa3a516ad3d8f7f8feae944d59de3fa20">duty_cycle_min</a>  = 0;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    led_sb_init_params.<a class="code" href="structled__sb__init__params__t.html#a7013c8a50be6e455c197a850c4a38330">duty_cycle_step</a> = 1;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    led_sb_init_params.<a class="code" href="structled__sb__init__params__t.html#a17ab324a39ce36e448e3bfaa32b9d4b0">leds_pin_bm</a>     = (<a class="code" href="group__ble__app__bootloader__main.html#ga3b95cf3b83cc132e0336162d25dd50f0">LED_R_MSK</a> | <a class="code" href="group__ble__app__bootloader__main.html#ga83e38b9ed71136a5b0554e3e7f166f59">LED_G_MSK</a> | <a class="code" href="group__ble__app__bootloader__main.html#gae1bc05d11c797a774394473305fc7f49">LED_B_MSK</a>);</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    led_sb_init_params.<a class="code" href="structled__sb__init__params__t.html#ab6a3651e84aa1e495864358f378e05f8">off_time_ms</a>     = 2000;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    led_sb_init_params.<a class="code" href="structled__sb__init__params__t.html#ab1c4af98b6f1c345bc6d5076f16492c7">on_time_ms</a>      = 0;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    </div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    err_code = <a class="code" href="led__softblink_8c.html#a684816018bccf8059226b930cf62e8ca" title="LED softblink initialization. ">led_softblink_init</a>(&amp;led_sb_init_params);</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    APP_ERROR_CHECK(err_code);        </div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;}</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00121"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga09658aaa0774820d8f25249d551bc283">  121</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__ble__app__bootloader__main.html#ga09658aaa0774820d8f25249d551bc283" title="Function for initializing the timer handler module (app_timer). ">timers_init</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;{</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="comment">// Initialize timer module, making it use the scheduler.</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <a class="code" href="group__app__timer.html#ga9eb4ec72345e8b61aa833ee299a788fe" title="Macro for initializing the application timer module. ">APP_TIMER_INIT</a>(<a class="code" href="group__ble__app__bootloader__main.html#ga7bbff5bb0ca047b109e70a831f08e217">APP_TIMER_PRESCALER</a>, <a class="code" href="group__ble__app__bootloader__main.html#gad5accf4f59399fd2dd980e1569deac3e">APP_TIMER_MAX_TIMERS</a>, <a class="code" href="group__ble__app__bootloader__main.html#ga756f526e607f350705dc7a2e05027cf2">APP_TIMER_OP_QUEUE_SIZE</a>, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;}</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div>
<div class="line"><a name="l00130"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga265c25c068555fbfae4ab4f391060040">  130</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__ble__app__bootloader__main.html#ga265c25c068555fbfae4ab4f391060040" title="Function for initializing the button module. ">buttons_init</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;{   </div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <a class="code" href="group__nrf__gpio.html#ga97fda94de057f7971c3a2ad325c66d75" title="Function for configuring the given GPIO pin number as input with given initial value set...">nrf_gpio_cfg_sense_input</a>(<a class="code" href="group__ble__app__bootloader__main.html#ga7556c95f108bb35fc78fa4b0c4cd4ee5">BOOTLOADER_BUTTON</a>,</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                             BUTTON_PULL, </div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                             <a class="code" href="group__nrf__gpio.html#gga0708136c752d69015962a2ccb4c59fbda48aaaa3fc33a295d9c65f094e03aba24" title="Pin sense low level. ">NRF_GPIO_PIN_SENSE_LOW</a>);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;}</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00146"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga7d572a7da8d6b8ddeabae8471710dd7c">  146</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__ble__app__bootloader__main.html#ga7d572a7da8d6b8ddeabae8471710dd7c" title="Function for dispatching a BLE stack event to all modules with a BLE stack event handler. ">sys_evt_dispatch</a>(uint32_t event)</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;{</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <a class="code" href="group__utility__functions.html#ga11860d5ebd557b256ede4ddd5d5d5aed" title="Handles Flash Access Result Events declared in pstorage_platform.h. ">pstorage_sys_event_handler</a>(event);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;}</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div>
<div class="line"><a name="l00160"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga10a92dcd75860163dd80a5bee569130e">  160</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__ble__app__bootloader__main.html#ga10a92dcd75860163dd80a5bee569130e" title="Function for initializing the BLE stack. ">ble_stack_init</a>(<span class="keywordtype">bool</span> init_softdevice)</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;{</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    uint32_t         err_code;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <a class="code" href="structsd__mbr__command__t.html">sd_mbr_command_t</a> com = {<a class="code" href="group___n_r_f___m_b_r___e_n_u_m_s.html#ggad416fbc71855eb8e1533a812164b85a7a1fcb02bcda46da19c7baff2b92c71fe5">SD_MBR_COMMAND_INIT_SD</a>, };</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="keywordflow">if</span> (init_softdevice)</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    {</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        err_code = sd_mbr_command(&amp;com);</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        APP_ERROR_CHECK(err_code);</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    }</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    err_code = sd_softdevice_vector_table_base_set(<a class="code" href="group__nrf__dfu__types.html#ga86b4872454e09cda5b4156b2f9f5f689">BOOTLOADER_REGION_START</a>);</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    APP_ERROR_CHECK(err_code);</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;   </div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <a class="code" href="group__softdevice__handler.html#ga9ff2f68caf148f0645c9953c93aa2ec7" title="Macro for initializing the stack event handler. ">SOFTDEVICE_HANDLER_INIT</a>(<a class="code" href="group___n_r_f___s_d_m___e_n_u_m_s.html#ggaef6aabaa8887cb4d7265d7e21b3ec242a2c0772805e06ad3966b4dc69abd3f247">NRF_CLOCK_LFCLKSRC_RC_250_PPM_8000MS_CALIBRATION</a>, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="comment">// Enable BLE stack </span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <a class="code" href="structble__enable__params__t.html" title="BLE GATTS init options. ">ble_enable_params_t</a> ble_enable_params;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    memset(&amp;ble_enable_params, 0, <span class="keyword">sizeof</span>(ble_enable_params));</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    ble_enable_params.<a class="code" href="structble__enable__params__t.html#aeb0ae8777c2b35cd985cb3505accfa4f">gatts_enable_params</a>.<a class="code" href="structble__gatts__enable__params__t.html#a887ca57e53964f933c525579f6ed1fa3">service_changed</a> = <a class="code" href="group__ble__app__bootloader__main.html#gac0ad4bcfe8e9edf6794e9a796378978a">IS_SRVC_CHANGED_CHARACT_PRESENT</a>;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    err_code = sd_ble_enable(&amp;ble_enable_params);</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    APP_ERROR_CHECK(err_code);</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    </div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    err_code = <a class="code" href="group__softdevice__handler.html#ga200d4e1f1c70a46e6de6343f0a7d84b1" title="Function for registering for System (SOC) events. ">softdevice_sys_evt_handler_set</a>(<a class="code" href="group__ble__app__bootloader__main.html#ga7d572a7da8d6b8ddeabae8471710dd7c" title="Function for dispatching a BLE stack event to all modules with a BLE stack event handler. ">sys_evt_dispatch</a>);</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    APP_ERROR_CHECK(err_code);</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;}</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div>
<div class="line"><a name="l00190"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#gaa4424e1347ed274a31b0cb843878f73e">  190</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__ble__app__bootloader__main.html#gaa4424e1347ed274a31b0cb843878f73e" title="Function for event scheduler initialization. ">scheduler_init</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;{</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <a class="code" href="group__app__scheduler.html#gaa9670ed0053a67304c3d2d0cb3eb1333" title="Macro for initializing the event scheduler. ">APP_SCHED_INIT</a>(<a class="code" href="group__ble__app__bootloader__main.html#ga069424fae4e23886ab0a3d0cec3f6980">SCHED_MAX_EVENT_DATA_SIZE</a>, <a class="code" href="group__ble__app__bootloader__main.html#ga473fb7cfbf660e0bbe6e4b8d8153e7bc">SCHED_QUEUE_SIZE</a>);</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;}</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div>
<div class="line"><a name="l00198"></a><span class="lineno"><a class="code" href="group__ble__app__bootloader__main.html#ga840291bc02cba5474a4cb46a9b9566fe">  198</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="group__ble__app__beacon__main.html#ga840291bc02cba5474a4cb46a9b9566fe" title="Function for application main entry. ">main</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;{</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    uint32_t err_code;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keywordtype">bool</span>     dfu_start = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="keywordtype">bool</span>     app_reset = (<a class="code" href="group___device___peripheral___registers.html#ga736bacc5025b0c30217b06fdf6778dc3">NRF_POWER</a>-&gt;GPREGRET == <a class="code" href="group__nrf__bootloader__types.html#ga5590b8ff0089e88358e46c506f54a688">BOOTLOADER_DFU_START</a>);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="keywordflow">if</span> (app_reset)</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    {</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <a class="code" href="group___device___peripheral___registers.html#ga736bacc5025b0c30217b06fdf6778dc3">NRF_POWER</a>-&gt;GPREGRET = 0;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    }</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="comment">// This check ensures that the defined fields in the bootloader corresponds with actual</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="comment">// setting in the nRF51 chip.</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    APP_ERROR_CHECK_BOOL(*((uint32_t *)<a class="code" href="group__nrf__dfu__types.html#gae4ec3580aab0657ce2c1212adec2c0b8">NRF_UICR_BOOT_START_ADDRESS</a>) == <a class="code" href="group__nrf__dfu__types.html#ga86b4872454e09cda5b4156b2f9f5f689">BOOTLOADER_REGION_START</a>);</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    APP_ERROR_CHECK_BOOL(<a class="code" href="group___device___peripheral___registers.html#gaf5b17d772ce3562100afd5460a22c615">NRF_FICR</a>-&gt;CODEPAGESIZE == <a class="code" href="group__nrf__dfu__types.html#ga8b56633cd2604d9fae053b04ff288841">CODE_PAGE_SIZE</a>);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="comment">// Initialize.</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <a class="code" href="group__ble__app__bootloader__main.html#ga09658aaa0774820d8f25249d551bc283" title="Function for initializing the timer handler module (app_timer). ">timers_init</a>();</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <a class="code" href="group__ble__app__bootloader__main.html#ga265c25c068555fbfae4ab4f391060040" title="Function for initializing the button module. ">buttons_init</a>();</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <a class="code" href="group__ble__app__bootloader__main.html#ga0892e076b365fc49b55bd0f90ab09222" title="Function for initialization of LEDs. ">leds_init</a>();</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    (void)<a class="code" href="group__nrf__bootloader.html#gaa821efb3c4074cee13cb2a7377e793f1" title="Function for initializing the Bootloader. ">bootloader_init</a>();</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__nrf__bootloader.html#ga360affe1c4d4326b4daa465dee005330" title="Function getting state of SoftDevice update in progress. After a successfull SoftDevice transfer the ...">bootloader_dfu_sd_in_progress</a>())</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    {</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <a class="code" href="led__softblink_8c.html#a2839d9167e2ea53d78cc2eb9084c45ed" title="Start blinking LED. ">led_softblink_start</a>(<a class="code" href="group__ble__app__bootloader__main.html#ga27fae3b4fea5c7fcc6ed9bde86186f9a">UPDATE_IN_PROGRESS_LED_MSK</a>);</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        err_code = <a class="code" href="group__nrf__bootloader.html#ga2edc94128b91cbdc2551be36dc692ef0" title="Function for continuing the Device Firmware Update of a SoftDevice. ">bootloader_dfu_sd_update_continue</a>();</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        APP_ERROR_CHECK(err_code);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <a class="code" href="group__ble__app__bootloader__main.html#ga10a92dcd75860163dd80a5bee569130e" title="Function for initializing the BLE stack. ">ble_stack_init</a>(!app_reset);</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <a class="code" href="group__ble__app__bootloader__main.html#gaa4424e1347ed274a31b0cb843878f73e" title="Function for event scheduler initialization. ">scheduler_init</a>();</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        err_code = <a class="code" href="group__nrf__bootloader.html#ga252165c548d698c2f001261314fecfce" title="Function for finalizing the Device Firmware Update of a SoftDevice. ">bootloader_dfu_sd_update_finalize</a>();</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        APP_ERROR_CHECK(err_code);</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        <a class="code" href="led__softblink_8c.html#af36d187293bf5474ea6b735bac1e042f" title="Stop blinking LED. ">led_softblink_stop</a>(<a class="code" href="group__ble__app__bootloader__main.html#ga27fae3b4fea5c7fcc6ed9bde86186f9a">UPDATE_IN_PROGRESS_LED_MSK</a>);</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    }</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    {</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        <span class="comment">// If stack is present then continue initialization of bootloader.</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <a class="code" href="group__ble__app__bootloader__main.html#ga10a92dcd75860163dd80a5bee569130e" title="Function for initializing the BLE stack. ">ble_stack_init</a>(!app_reset);</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        <a class="code" href="group__ble__app__bootloader__main.html#gaa4424e1347ed274a31b0cb843878f73e" title="Function for event scheduler initialization. ">scheduler_init</a>();</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    }</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    dfu_start  = app_reset;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    dfu_start |= ((<a class="code" href="group__nrf__gpio.html#ga0983906029818d8aa199b71b578d1c12" title="Function for reading the input level of a GPIO pin. ">nrf_gpio_pin_read</a>(<a class="code" href="group__ble__app__bootloader__main.html#ga7556c95f108bb35fc78fa4b0c4cd4ee5">BOOTLOADER_BUTTON</a>) == 0) ? <span class="keyword">true</span>: <span class="keyword">false</span>);</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    </div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="keywordflow">if</span> (dfu_start || (!<a class="code" href="group__nrf__bootloader.html#gabd325fffda0cb29f1a8b917eb61d2494" title="Function for validating application region in flash. ">bootloader_app_is_valid</a>(<a class="code" href="group__nrf__dfu__types.html#ga39e80d54dfce36ce719b5d546a8b1326">DFU_BANK_0_REGION_START</a>)))</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    {</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        <a class="code" href="led__softblink_8c.html#a2839d9167e2ea53d78cc2eb9084c45ed" title="Start blinking LED. ">led_softblink_start</a>(<a class="code" href="group__ble__app__bootloader__main.html#ga27fae3b4fea5c7fcc6ed9bde86186f9a">UPDATE_IN_PROGRESS_LED_MSK</a>);</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        <span class="comment">// Initiate an update of the firmware.</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        err_code = <a class="code" href="group__nrf__bootloader.html#gaf11a485218863db81385fe18437b5961" title="Function for starting the Device Firmware Update. ">bootloader_dfu_start</a>();</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        APP_ERROR_CHECK(err_code);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        </div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        <a class="code" href="led__softblink_8c.html#af36d187293bf5474ea6b735bac1e042f" title="Stop blinking LED. ">led_softblink_stop</a>(<a class="code" href="group__ble__app__bootloader__main.html#ga27fae3b4fea5c7fcc6ed9bde86186f9a">UPDATE_IN_PROGRESS_LED_MSK</a>);</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    }</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="group__nrf__bootloader.html#gabd325fffda0cb29f1a8b917eb61d2494" title="Function for validating application region in flash. ">bootloader_app_is_valid</a>(<a class="code" href="group__nrf__dfu__types.html#ga39e80d54dfce36ce719b5d546a8b1326">DFU_BANK_0_REGION_START</a>))</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    {</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <span class="comment">// Select a bank region to use as application region.</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        <span class="comment">// @note: Only applications running from DFU_BANK_0_REGION_START is supported.</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        <a class="code" href="group__nrf__bootloader.html#ga4fc5191d040a4abb9a23b52e22f56101" title="Function for exiting bootloader and booting into application. ">bootloader_app_start</a>(<a class="code" href="group__nrf__dfu__types.html#ga39e80d54dfce36ce719b5d546a8b1326">DFU_BANK_0_REGION_START</a>);</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    }</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    </div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    NVIC_SystemReset();</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_753c3ab39a1e65d5d58171958880fde4.html">nrf51_beacon</a></li><li class="navelem"><a class="el" href="dir_c9f0536aaef75a19cc06891f126dc56e.html">ble_app_beacon_dfu</a></li><li class="navelem"><a class="el" href="dir_08e6c3fdddf01ad012396708f4ddcb12.html">bootloader</a></li><li class="navelem"><a class="el" href="dfu_2bootloader_2main_8c.html">main.c</a></li>
    <li class="footer">Generated on Mon Apr 13 2015 11:33:09 for nRF51822 Beacon Firmware Documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
