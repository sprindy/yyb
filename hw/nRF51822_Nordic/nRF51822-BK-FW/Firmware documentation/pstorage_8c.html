<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>nRF51822 Beacon Firmware Documentation: components/drivers_nrf/pstorage/pstorage.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF51822 Beacon Firmware Documentation
   &#160;<span id="projectnumber">v1.1.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('pstorage_8c.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#enum-members">Enumerations</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">pstorage.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="pstorage_8h_source.html">pstorage.h</a>&quot;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;stdint.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &quot;nordic_common.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="nrf__error_8h_source.html">nrf_error.h</a>&quot;</code><br/>
<code>#include &quot;nrf_assert.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="nrf_8h_source.html">nrf.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="nrf__soc_8h_source.html">nrf_soc.h</a>&quot;</code><br/>
<code>#include &quot;app_util.h&quot;</code><br/>
</div>
<p><a href="pstorage_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structpstorage__module__table__t.html">pstorage_module_table_t</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Application registration information.  <a href="structpstorage__module__table__t.html#details">More...</a><br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structcmd__queue__element__t.html">cmd_queue_element_t</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Defines command queue element.  <a href="structcmd__queue__element__t.html#details">More...</a><br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structcmd__queue__t.html">cmd_queue_t</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Defines command queue, an element is free if op_code field is not invalid.  <a href="structcmd__queue__t.html#details">More...</a><br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ae8a964fad9f97467ca7fc24e214a9e01"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#ae8a964fad9f97467ca7fc24e214a9e01">INVALID_OPCODE</a>&#160;&#160;&#160;0x00</td></tr>
<tr class="separator:ae8a964fad9f97467ca7fc24e214a9e01"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a331ea60527b8d933979a04a0d1931329"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#a331ea60527b8d933979a04a0d1931329">SOC_MAX_WRITE_SIZE</a>&#160;&#160;&#160;1024</td></tr>
<tr class="separator:a331ea60527b8d933979a04a0d1931329"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a94b4283cfb2fa7e5353d3e45d7033872"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#a94b4283cfb2fa7e5353d3e45d7033872">RAW_MODE_APP_ID</a>&#160;&#160;&#160;(PSTORAGE_MAX_APPLICATIONS + 1)</td></tr>
<tr class="separator:a94b4283cfb2fa7e5353d3e45d7033872"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gadc3e2547b67be7deaa8497592f86e156"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__api__param__check.html#gadc3e2547b67be7deaa8497592f86e156">NULL_PARAM_CHECK</a>(PARAM)</td></tr>
<tr class="memdesc:gadc3e2547b67be7deaa8497592f86e156"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check if the input pointer is NULL, if it is returns NRF_ERROR_NULL.  <a href="group__api__param__check.html#gadc3e2547b67be7deaa8497592f86e156">More...</a><br/></td></tr>
<tr class="separator:gadc3e2547b67be7deaa8497592f86e156"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaae9da1fe8e7ab5ff48f1bfec1a3e021a"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__api__param__check.html#gaae9da1fe8e7ab5ff48f1bfec1a3e021a">MODULE_ID_RANGE_CHECK</a>(ID)</td></tr>
<tr class="memdesc:gaae9da1fe8e7ab5ff48f1bfec1a3e021a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Verifies the module identifier supplied by the application is within permissible range.  <a href="group__api__param__check.html#gaae9da1fe8e7ab5ff48f1bfec1a3e021a">More...</a><br/></td></tr>
<tr class="separator:gaae9da1fe8e7ab5ff48f1bfec1a3e021a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gac113d37e10e428c70c18b974d0e1aba6"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__api__param__check.html#gac113d37e10e428c70c18b974d0e1aba6">BLOCK_ID_RANGE_CHECK</a>(ID)</td></tr>
<tr class="memdesc:gac113d37e10e428c70c18b974d0e1aba6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Verifies the block identifier supplied by the application is within the permissible range.  <a href="group__api__param__check.html#gac113d37e10e428c70c18b974d0e1aba6">More...</a><br/></td></tr>
<tr class="separator:gac113d37e10e428c70c18b974d0e1aba6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga390c0edec329da58f574fd36b99fbcd6"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__api__param__check.html#ga390c0edec329da58f574fd36b99fbcd6">BLOCK_SIZE_CHECK</a>(X)</td></tr>
<tr class="memdesc:ga390c0edec329da58f574fd36b99fbcd6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Verifies the block size requested by the application can be supported by the module.  <a href="group__api__param__check.html#ga390c0edec329da58f574fd36b99fbcd6">More...</a><br/></td></tr>
<tr class="separator:ga390c0edec329da58f574fd36b99fbcd6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga5e14b8accad4619d2ae281ddeea57b81"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__api__param__check.html#ga5e14b8accad4619d2ae281ddeea57b81">BLOCK_COUNT_CHECK</a>(COUNT, SIZE)</td></tr>
<tr class="memdesc:ga5e14b8accad4619d2ae281ddeea57b81"><td class="mdescLeft">&#160;</td><td class="mdescRight">Verifies block size requested by Application in registration API.  <a href="group__api__param__check.html#ga5e14b8accad4619d2ae281ddeea57b81">More...</a><br/></td></tr>
<tr class="separator:ga5e14b8accad4619d2ae281ddeea57b81"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga411cb019552dba20f70efe942571c06a"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__api__param__check.html#ga411cb019552dba20f70efe942571c06a">SIZE_CHECK</a>(ID, SIZE)</td></tr>
<tr class="memdesc:ga411cb019552dba20f70efe942571c06a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Verifies size parameter provided by application in API.  <a href="group__api__param__check.html#ga411cb019552dba20f70efe942571c06a">More...</a><br/></td></tr>
<tr class="separator:ga411cb019552dba20f70efe942571c06a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga7422f4fbd01befcc308edfcbd75b066c"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__api__param__check.html#ga7422f4fbd01befcc308edfcbd75b066c">OFFSET_CHECK</a>(ID, OFFSET, SIZE)</td></tr>
<tr class="memdesc:ga7422f4fbd01befcc308edfcbd75b066c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Verifies offset parameter provided by application in API.  <a href="group__api__param__check.html#ga7422f4fbd01befcc308edfcbd75b066c">More...</a><br/></td></tr>
<tr class="separator:ga7422f4fbd01befcc308edfcbd75b066c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6e4917fcb7e2eca587b8114a78a5e184"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#a6e4917fcb7e2eca587b8114a78a5e184">VERIFY_MODULE_INITIALIZED</a>()</td></tr>
<tr class="memdesc:a6e4917fcb7e2eca587b8114a78a5e184"><td class="mdescLeft">&#160;</td><td class="mdescRight">Verify module's initialization status.  <a href="#a6e4917fcb7e2eca587b8114a78a5e184">More...</a><br/></td></tr>
<tr class="separator:a6e4917fcb7e2eca587b8114a78a5e184"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd01180037c08795d18b60f42068b4d9"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#acd01180037c08795d18b60f42068b4d9">MODULE_BLOCK_SIZE</a>(ID)&#160;&#160;&#160;(<a class="el" href="pstorage__nosd_8c.html#a61d34204e440691235ecf310f87002af">m_app_table</a>[(ID)-&gt;module_id].block_size)</td></tr>
<tr class="memdesc:acd01180037c08795d18b60f42068b4d9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Macro to fetch the block size registered for the module.  <a href="#acd01180037c08795d18b60f42068b4d9">More...</a><br/></td></tr>
<tr class="separator:acd01180037c08795d18b60f42068b4d9"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:a69fa0c3173bb59cc6a4907cb18de03ec"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#a69fa0c3173bb59cc6a4907cb18de03ec">swap_backup_state_t</a> { <br/>
&#160;&#160;<a class="el" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca98d2a2153b4ae0445fa0b114d65b94d9">STATE_INIT</a>, 
<a class="el" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca38dc08c7fee1ad64f0a62788c9c9a8c1">STATE_DATA_TO_SWAP_WRITE</a>, 
<a class="el" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca8bf8e397bd25d4a5b8f06e844026b616">STATE_DATA_ERASE</a>, 
<a class="el" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ecaf54478673392a43ef3c887b3db89b0a9">STATE_HEAD_RESTORE</a>, 
<br/>
&#160;&#160;<a class="el" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca47083903ebe8137c35d40ffc57ae355e">STATE_TAIL_RESTORE</a>, 
<a class="el" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ecae7960498d64521690dd52b61ff4ab2d5">STATE_NEW_BODY_WRITE</a>, 
<a class="el" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca240812b0e713ea6c50fe47cfdb2528b4">STATE_SWAP_ERASE</a>, 
<a class="el" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca79ae1582c50ffdc26c332345ede75d7c">STATE_COMPLETE</a>, 
<br/>
&#160;&#160;<a class="el" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca2f95a4ddba06ae64a00fcb3178a8114f">STATE_SWAP_DIRTY</a>, 
<a class="el" href="pstorage_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca98d2a2153b4ae0445fa0b114d65b94d9">STATE_INIT</a>, 
<a class="el" href="pstorage_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca38dc08c7fee1ad64f0a62788c9c9a8c1">STATE_DATA_TO_SWAP_WRITE</a>, 
<a class="el" href="pstorage_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca8bf8e397bd25d4a5b8f06e844026b616">STATE_DATA_ERASE</a>, 
<br/>
&#160;&#160;<a class="el" href="pstorage_8c.html#a69fa0c3173bb59cc6a4907cb18de03ecaf54478673392a43ef3c887b3db89b0a9">STATE_HEAD_RESTORE</a>, 
<a class="el" href="pstorage_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca47083903ebe8137c35d40ffc57ae355e">STATE_TAIL_RESTORE</a>, 
<a class="el" href="pstorage_8c.html#a69fa0c3173bb59cc6a4907cb18de03ecae7960498d64521690dd52b61ff4ab2d5">STATE_NEW_BODY_WRITE</a>, 
<a class="el" href="pstorage_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca240812b0e713ea6c50fe47cfdb2528b4">STATE_SWAP_ERASE</a>, 
<br/>
&#160;&#160;<a class="el" href="pstorage_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca79ae1582c50ffdc26c332345ede75d7c">STATE_COMPLETE</a>, 
<a class="el" href="pstorage_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca2f95a4ddba06ae64a00fcb3178a8114f">STATE_SWAP_DIRTY</a>
<br/>
 }</td></tr>
<tr class="memdesc:a69fa0c3173bb59cc6a4907cb18de03ec"><td class="mdescLeft">&#160;</td><td class="mdescRight">States for the Update/Clear swap backup state machine.  <a href="pstorage_8c.html#a69fa0c3173bb59cc6a4907cb18de03ec">More...</a><br/></td></tr>
<tr class="separator:a69fa0c3173bb59cc6a4907cb18de03ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga78a52b91014e89edc2a765f42f792b3f"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#ga78a52b91014e89edc2a765f42f792b3f">cmd_process</a> (void)</td></tr>
<tr class="memdesc:ga78a52b91014e89edc2a765f42f792b3f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Routine called to actually issue the flash access request to the SoftDevice.  <a href="#ga78a52b91014e89edc2a765f42f792b3f">More...</a><br/></td></tr>
<tr class="separator:ga78a52b91014e89edc2a765f42f792b3f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga8263f9982462bfa03139a2be26961344"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__utility__functions.html#ga8263f9982462bfa03139a2be26961344">app_notify</a> (uint32_t result)</td></tr>
<tr class="memdesc:ga8263f9982462bfa03139a2be26961344"><td class="mdescLeft">&#160;</td><td class="mdescRight">Routine to notify application of any errors.  <a href="group__utility__functions.html#ga8263f9982462bfa03139a2be26961344">More...</a><br/></td></tr>
<tr class="separator:ga8263f9982462bfa03139a2be26961344"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga544e69fa09540f4db68d8a144a963310"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#ga544e69fa09540f4db68d8a144a963310">cmd_queue_element_init</a> (uint32_t index)</td></tr>
<tr class="memdesc:ga544e69fa09540f4db68d8a144a963310"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes command queue element.  <a href="#ga544e69fa09540f4db68d8a144a963310">More...</a><br/></td></tr>
<tr class="separator:ga544e69fa09540f4db68d8a144a963310"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gade390fede7a3eff9869a7850a6b53c02"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#gade390fede7a3eff9869a7850a6b53c02">cmd_queue_init</a> (void)</td></tr>
<tr class="memdesc:gade390fede7a3eff9869a7850a6b53c02"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes command queue.  <a href="#gade390fede7a3eff9869a7850a6b53c02">More...</a><br/></td></tr>
<tr class="separator:gade390fede7a3eff9869a7850a6b53c02"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga161eddb644ed938b9341102ac2237844"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#ga161eddb644ed938b9341102ac2237844">cmd_queue_enqueue</a> (uint8_t opcode, pstorage_handle_t *p_storage_addr, uint8_t *p_data_addr, pstorage_size_t size, pstorage_size_t offset)</td></tr>
<tr class="memdesc:ga161eddb644ed938b9341102ac2237844"><td class="mdescLeft">&#160;</td><td class="mdescRight">Routine to enqueue a flash access operation.  <a href="#ga161eddb644ed938b9341102ac2237844">More...</a><br/></td></tr>
<tr class="separator:ga161eddb644ed938b9341102ac2237844"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga5026eeb68df47eb0714f063471b14c12"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#ga5026eeb68df47eb0714f063471b14c12">cmd_queue_dequeue</a> (void)</td></tr>
<tr class="memdesc:ga5026eeb68df47eb0714f063471b14c12"><td class="mdescLeft">&#160;</td><td class="mdescRight">Dequeues a command element.  <a href="#ga5026eeb68df47eb0714f063471b14c12">More...</a><br/></td></tr>
<tr class="separator:ga5026eeb68df47eb0714f063471b14c12"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga11860d5ebd557b256ede4ddd5d5d5aed"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__utility__functions.html#ga11860d5ebd557b256ede4ddd5d5d5aed">pstorage_sys_event_handler</a> (uint32_t sys_evt)</td></tr>
<tr class="memdesc:ga11860d5ebd557b256ede4ddd5d5d5aed"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handles Flash Access Result Events declared in pstorage_platform.h.  <a href="group__utility__functions.html#ga11860d5ebd557b256ede4ddd5d5d5aed">More...</a><br/></td></tr>
<tr class="separator:ga11860d5ebd557b256ede4ddd5d5d5aed"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga3a61c82e63c372562b71466b441cefc2"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#ga3a61c82e63c372562b71466b441cefc2">swap_state_process</a> (<a class="el" href="structcmd__queue__element__t.html">cmd_queue_element_t</a> *p_cmd, uint32_t page_number, uint32_t head_word_size, uint32_t tail_word_size)</td></tr>
<tr class="memdesc:ga3a61c82e63c372562b71466b441cefc2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Function for handling flash accesses when using swap.  <a href="#ga3a61c82e63c372562b71466b441cefc2">More...</a><br/></td></tr>
<tr class="separator:ga3a61c82e63c372562b71466b441cefc2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga729ef8b64fc0cb6bfdabb2543a565d32"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__pstorage__routines.html#ga729ef8b64fc0cb6bfdabb2543a565d32">pstorage_init</a> (void)</td></tr>
<tr class="memdesc:ga729ef8b64fc0cb6bfdabb2543a565d32"><td class="mdescLeft">&#160;</td><td class="mdescRight">Module Initialization Routine.  <a href="group__pstorage__routines.html#ga729ef8b64fc0cb6bfdabb2543a565d32">More...</a><br/></td></tr>
<tr class="separator:ga729ef8b64fc0cb6bfdabb2543a565d32"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga0a57b964c8945eaca2d267835ef6688c"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__pstorage__routines.html#ga0a57b964c8945eaca2d267835ef6688c">pstorage_register</a> (<a class="el" href="structpstorage__module__param__t.html">pstorage_module_param_t</a> *p_module_param, pstorage_handle_t *p_block_id)</td></tr>
<tr class="memdesc:ga0a57b964c8945eaca2d267835ef6688c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Register with persistent storage interface.  <a href="group__pstorage__routines.html#ga0a57b964c8945eaca2d267835ef6688c">More...</a><br/></td></tr>
<tr class="separator:ga0a57b964c8945eaca2d267835ef6688c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gafdeeb475e4f2db19863226bc55d507b5"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__pstorage__routines.html#gafdeeb475e4f2db19863226bc55d507b5">pstorage_block_identifier_get</a> (pstorage_handle_t *p_base_id, pstorage_size_t block_num, pstorage_handle_t *p_block_id)</td></tr>
<tr class="memdesc:gafdeeb475e4f2db19863226bc55d507b5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Function to get block id with reference to base block identifier provided at time of registration.  <a href="group__pstorage__routines.html#gafdeeb475e4f2db19863226bc55d507b5">More...</a><br/></td></tr>
<tr class="separator:gafdeeb475e4f2db19863226bc55d507b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga12e52da12709de8d43bfb8389b80af6d"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__pstorage__routines.html#ga12e52da12709de8d43bfb8389b80af6d">pstorage_store</a> (pstorage_handle_t *p_dest, uint8_t *p_src, pstorage_size_t size, pstorage_size_t offset)</td></tr>
<tr class="memdesc:ga12e52da12709de8d43bfb8389b80af6d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Routine to persistently store data of length 'size' contained in 'p_src' address in storage module at 'p_dest' address; Equivalent to Storage Write.  <a href="group__pstorage__routines.html#ga12e52da12709de8d43bfb8389b80af6d">More...</a><br/></td></tr>
<tr class="separator:ga12e52da12709de8d43bfb8389b80af6d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga0316f640da7481e9bd03ed51b29a3e65"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__pstorage__routines.html#ga0316f640da7481e9bd03ed51b29a3e65">pstorage_update</a> (pstorage_handle_t *p_dest, uint8_t *p_src, pstorage_size_t size, pstorage_size_t offset)</td></tr>
<tr class="memdesc:ga0316f640da7481e9bd03ed51b29a3e65"><td class="mdescLeft">&#160;</td><td class="mdescRight">Routine to update persistently stored data of length 'size' contained in 'p_src' address in storage module at 'p_dest' address.  <a href="group__pstorage__routines.html#ga0316f640da7481e9bd03ed51b29a3e65">More...</a><br/></td></tr>
<tr class="separator:ga0316f640da7481e9bd03ed51b29a3e65"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga99402440650cc2d2ee63d8866760a25b"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__pstorage__routines.html#ga99402440650cc2d2ee63d8866760a25b">pstorage_load</a> (uint8_t *p_dest, pstorage_handle_t *p_src, pstorage_size_t size, pstorage_size_t offset)</td></tr>
<tr class="memdesc:ga99402440650cc2d2ee63d8866760a25b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Routine to load persistently stored data of length 'size' from 'p_src' address to 'p_dest' address; Equivalent to Storage Read.  <a href="group__pstorage__routines.html#ga99402440650cc2d2ee63d8866760a25b">More...</a><br/></td></tr>
<tr class="separator:ga99402440650cc2d2ee63d8866760a25b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga64d9814f864c3f771a99eb7574e87dd0"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__pstorage__routines.html#ga64d9814f864c3f771a99eb7574e87dd0">pstorage_clear</a> (pstorage_handle_t *p_dest, pstorage_size_t size)</td></tr>
<tr class="memdesc:ga64d9814f864c3f771a99eb7574e87dd0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Routine to clear data in persistent memory.  <a href="group__pstorage__routines.html#ga64d9814f864c3f771a99eb7574e87dd0">More...</a><br/></td></tr>
<tr class="separator:ga64d9814f864c3f771a99eb7574e87dd0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga1553a4d6d6d8ddf070d0eb4960b72d62"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__pstorage__routines.html#ga1553a4d6d6d8ddf070d0eb4960b72d62">pstorage_access_status_get</a> (uint32_t *p_count)</td></tr>
<tr class="memdesc:ga1553a4d6d6d8ddf070d0eb4960b72d62"><td class="mdescLeft">&#160;</td><td class="mdescRight">API to get status of number of pending operations with the module.  <a href="group__pstorage__routines.html#ga1553a4d6d6d8ddf070d0eb4960b72d62">More...</a><br/></td></tr>
<tr class="separator:ga1553a4d6d6d8ddf070d0eb4960b72d62"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:aa4316c8dd50f357ae5f6b4d5c8c2e85a"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structcmd__queue__t.html">cmd_queue_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a></td></tr>
<tr class="separator:aa4316c8dd50f357ae5f6b4d5c8c2e85a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeb0ea5d8898efee3644c43b2206d4a57"><td class="memItemLeft" align="right" valign="top">static pstorage_size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#aeb0ea5d8898efee3644c43b2206d4a57">m_next_app_instance</a></td></tr>
<tr class="separator:aeb0ea5d8898efee3644c43b2206d4a57"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2d3292c0e300f3deb4b05d9fe6354779"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#a2d3292c0e300f3deb4b05d9fe6354779">m_next_page_addr</a></td></tr>
<tr class="separator:a2d3292c0e300f3deb4b05d9fe6354779"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afa78b6a4bd7867f97c12b4ff45e9db22"><td class="memItemLeft" align="right" valign="top">static pstorage_size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#afa78b6a4bd7867f97c12b4ff45e9db22">m_round_val</a></td></tr>
<tr class="separator:afa78b6a4bd7867f97c12b4ff45e9db22"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7e99e7d02e854ee64a37440c60bf641e"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#a7e99e7d02e854ee64a37440c60bf641e">m_module_initialized</a> = false</td></tr>
<tr class="separator:a7e99e7d02e854ee64a37440c60bf641e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a424c25c247944aad095274cfd4429646"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ec">swap_backup_state_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a></td></tr>
<tr class="separator:a424c25c247944aad095274cfd4429646"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a61d34204e440691235ecf310f87002af"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structpstorage__module__table__t.html">pstorage_module_table_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="pstorage_8c.html#a61d34204e440691235ecf310f87002af">m_app_table</a> [PSTORAGE_MAX_APPLICATIONS]</td></tr>
<tr class="separator:a61d34204e440691235ecf310f87002af"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="ae8a964fad9f97467ca7fc24e214a9e01"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define INVALID_OPCODE&#160;&#160;&#160;0x00</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Invalid op code identifier. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00024">24</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

</div>
</div>
<a class="anchor" id="a331ea60527b8d933979a04a0d1931329"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SOC_MAX_WRITE_SIZE&#160;&#160;&#160;1024</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Maximum write size allowed for a single call to sd_flash_write as specified in the SoC API. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00025">25</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

</div>
</div>
<a class="anchor" id="a94b4283cfb2fa7e5353d3e45d7033872"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RAW_MODE_APP_ID&#160;&#160;&#160;(PSTORAGE_MAX_APPLICATIONS + 1)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Application id for raw mode. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00026">26</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

</div>
</div>
<a class="anchor" id="a6e4917fcb7e2eca587b8114a78a5e184"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define VERIFY_MODULE_INITIALIZED</td>
          <td>(</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line"><span class="keywordflow">do</span>                                                                                        \</div>
<div class="line">        {                                                                                         \</div>
<div class="line">            if (!<a class="code" href="pstorage_8c.html#a7e99e7d02e854ee64a37440c60bf641e">m_module_initialized</a>)                                                            \</div>
<div class="line">            {                                                                                     \</div>
<div class="line">                 return <a class="code" href="group__nrf__error.html#gaf0aff2ba7864b34a36b4a96986e1851e" title="Invalid state, operation disallowed in this state. ">NRF_ERROR_INVALID_STATE</a>;                                                  \</div>
<div class="line">            }                                                                                     \</div>
<div class="line">        } <span class="keywordflow">while</span>(0)</div>
</div><!-- fragment -->
<p>Verify module's initialization status. </p>
<p>Verify module's initialization status. Returns NRF_ERROR_INVALID_STATE in case a module API is called without initializing the module. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00128">128</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

</div>
</div>
<a class="anchor" id="acd01180037c08795d18b60f42068b4d9"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MODULE_BLOCK_SIZE</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">ID)</td><td></td>
          <td>&#160;&#160;&#160;(<a class="el" href="pstorage__nosd_8c.html#a61d34204e440691235ecf310f87002af">m_app_table</a>[(ID)-&gt;module_id].block_size)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Macro to fetch the block size registered for the module. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00138">138</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Enumeration Type Documentation</h2>
<a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03ec"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ec">swap_backup_state_t</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>States for the Update/Clear swap backup state machine. </p>
<table class="fieldtable">
<tr><th colspan="2">Enumerator</th></tr><tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca98d2a2153b4ae0445fa0b114d65b94d9"></a>STATE_INIT</em>&nbsp;</td><td class="fielddoc">
<p>State for indicating that swap can be used when using update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca38dc08c7fee1ad64f0a62788c9c9a8c1"></a>STATE_DATA_TO_SWAP_WRITE</em>&nbsp;</td><td class="fielddoc">
<p>State for doing backup of data page into the swap page when using update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca8bf8e397bd25d4a5b8f06e844026b616"></a>STATE_DATA_ERASE</em>&nbsp;</td><td class="fielddoc">
<p>State for erasing data page when using update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03ecaf54478673392a43ef3c887b3db89b0a9"></a>STATE_HEAD_RESTORE</em>&nbsp;</td><td class="fielddoc">
<p>State for restoring head (beginning) of backed up data from swap to data page when using update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca47083903ebe8137c35d40ffc57ae355e"></a>STATE_TAIL_RESTORE</em>&nbsp;</td><td class="fielddoc">
<p>State for restoring tail (end) of backed up data from swap to data page when using update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03ecae7960498d64521690dd52b61ff4ab2d5"></a>STATE_NEW_BODY_WRITE</em>&nbsp;</td><td class="fielddoc">
<p>State for writing body (middle) data to the data page when using update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca240812b0e713ea6c50fe47cfdb2528b4"></a>STATE_SWAP_ERASE</em>&nbsp;</td><td class="fielddoc">
<p>State for erasing the swap page when using the update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca79ae1582c50ffdc26c332345ede75d7c"></a>STATE_COMPLETE</em>&nbsp;</td><td class="fielddoc">
<p>State for indicating that update/clear sequence is completed internal in the module when using the update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca2f95a4ddba06ae64a00fcb3178a8114f"></a>STATE_SWAP_DIRTY</em>&nbsp;</td><td class="fielddoc">
<p>State for initializing the swap region on module initialization. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca98d2a2153b4ae0445fa0b114d65b94d9"></a>STATE_INIT</em>&nbsp;</td><td class="fielddoc">
<p>State for indicating that swap can be used when using update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca38dc08c7fee1ad64f0a62788c9c9a8c1"></a>STATE_DATA_TO_SWAP_WRITE</em>&nbsp;</td><td class="fielddoc">
<p>State for doing backup of data page into the swap page when using update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca8bf8e397bd25d4a5b8f06e844026b616"></a>STATE_DATA_ERASE</em>&nbsp;</td><td class="fielddoc">
<p>State for erasing data page when using update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03ecaf54478673392a43ef3c887b3db89b0a9"></a>STATE_HEAD_RESTORE</em>&nbsp;</td><td class="fielddoc">
<p>State for restoring head (beginning) of backed up data from swap to data page when using update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca47083903ebe8137c35d40ffc57ae355e"></a>STATE_TAIL_RESTORE</em>&nbsp;</td><td class="fielddoc">
<p>State for restoring tail (end) of backed up data from swap to data page when using update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03ecae7960498d64521690dd52b61ff4ab2d5"></a>STATE_NEW_BODY_WRITE</em>&nbsp;</td><td class="fielddoc">
<p>State for writing body (middle) data to the data page when using update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca240812b0e713ea6c50fe47cfdb2528b4"></a>STATE_SWAP_ERASE</em>&nbsp;</td><td class="fielddoc">
<p>State for erasing the swap page when using the update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca79ae1582c50ffdc26c332345ede75d7c"></a>STATE_COMPLETE</em>&nbsp;</td><td class="fielddoc">
<p>State for indicating that update/clear sequence is completed internal in the module when using the update/clear API. </p>
</td></tr>
<tr><td class="fieldname"><em><a class="anchor" id="a69fa0c3173bb59cc6a4907cb18de03eca2f95a4ddba06ae64a00fcb3178a8114f"></a>STATE_SWAP_DIRTY</em>&nbsp;</td><td class="fielddoc">
<p>State for initializing the swap region on module initialization. </p>
</td></tr>
</table>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00142">142</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;{</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca98d2a2153b4ae0445fa0b114d65b94d9">STATE_INIT</a>,                </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca38dc08c7fee1ad64f0a62788c9c9a8c1">STATE_DATA_TO_SWAP_WRITE</a>,  </div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca8bf8e397bd25d4a5b8f06e844026b616">STATE_DATA_ERASE</a>,          </div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ecaf54478673392a43ef3c887b3db89b0a9">STATE_HEAD_RESTORE</a>,        </div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca47083903ebe8137c35d40ffc57ae355e">STATE_TAIL_RESTORE</a>,        </div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ecae7960498d64521690dd52b61ff4ab2d5">STATE_NEW_BODY_WRITE</a>,      </div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca240812b0e713ea6c50fe47cfdb2528b4">STATE_SWAP_ERASE</a>,          </div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca79ae1582c50ffdc26c332345ede75d7c">STATE_COMPLETE</a>,            </div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca2f95a4ddba06ae64a00fcb3178a8114f">STATE_SWAP_DIRTY</a>           </div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;} <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ec" title="States for the Update/Clear swap backup state machine. ">swap_backup_state_t</a>;</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ga78a52b91014e89edc2a765f42f792b3f"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static uint32_t cmd_process </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Routine called to actually issue the flash access request to the SoftDevice. </p>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">NRF_SUCCESS</td><td>on success, else an error code indicating reason for failure. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00699">699</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

<p>References <a class="el" href="pstorage__mod_8c_source.html#l00165">pstorage_module_table_t::base_id</a>, <a class="el" href="pstorage__mod_8c_source.html#l00167">pstorage_module_table_t::block_count</a>, <a class="el" href="pstorage__mod_8c_source.html#l00166">pstorage_module_table_t::block_size</a>, <a class="el" href="pstorage__mod_8c_source.html#l00216">cmd_queue_t::cmd</a>, <a class="el" href="pstorage__mod_8c_source.html#l00215">cmd_queue_t::flash_access</a>, <a class="el" href="pstorage_8c_source.html#l00223">m_round_val</a>, <a class="el" href="nrf__error_8h_source.html#l00043">NRF_ERROR_FORBIDDEN</a>, <a class="el" href="nrf__error_8h_source.html#l00028">NRF_SUCCESS</a>, <a class="el" href="pstorage__mod_8c_source.html#l00196">cmd_queue_element_t::offset</a>, <a class="el" href="pstorage__mod_8c_source.html#l00194">cmd_queue_element_t::op_code</a>, <a class="el" href="pstorage__mod_8c_source.html#l00198">cmd_queue_element_t::p_data_addr</a>, <a class="el" href="pstorage_8h_source.html#l00044">PSTORAGE_CLEAR_OP_CODE</a>, <a class="el" href="pstorage_8h_source.html#l00042">PSTORAGE_STORE_OP_CODE</a>, <a class="el" href="pstorage_8h_source.html#l00045">PSTORAGE_UPDATE_OP_CODE</a>, <a class="el" href="pstorage_8c_source.html#l00026">RAW_MODE_APP_ID</a>, <a class="el" href="pstorage__mod_8c_source.html#l00213">cmd_queue_t::rp</a>, <a class="el" href="pstorage__mod_8c_source.html#l00195">cmd_queue_element_t::size</a>, <a class="el" href="pstorage_8c_source.html#l00025">SOC_MAX_WRITE_SIZE</a>, <a class="el" href="pstorage__mod_8c_source.html#l00197">cmd_queue_element_t::storage_addr</a>, and <a class="el" href="pstorage_8c_source.html#l00545">swap_state_process()</a>.</p>
<div class="fragment"><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;{</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    uint32_t              retval;</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    uint32_t              storage_addr;</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    <a class="code" href="structcmd__queue__element__t.html" title="Defines command queue element. ">cmd_queue_element_t</a> * p_cmd;</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    retval = <a class="code" href="group__nrf__error.html#ga85125dae5d7e9d4b9964acbc13f641b3" title="Forbidden Operation. ">NRF_ERROR_FORBIDDEN</a>;</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    p_cmd = &amp;<a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a25793c5153d0cbe87bf12d48651aed0b">cmd</a>[<a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a31aabaf2a8bf00cb533484429f9c71ae">rp</a>];</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    storage_addr = p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#aef41919fc24bd42394ad7a3f06e1ac03">storage_addr</a>.block_id;</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    <span class="keywordflow">switch</span> (p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a52f5d121921fededbdbea9127fc7b62b">op_code</a>)</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    {</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="group__ps__opcode.html#gad1415b8815fc4e0ba8f4f6bc2d8e3ce6">PSTORAGE_STORE_OP_CODE</a>:</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        {</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;            uint32_t  size;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;            uint32_t  offset;</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;            uint8_t * p_data_addr = p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a65b61e75a076b291e7e2defa91d7df80">p_data_addr</a>;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;            offset        = (<a class="code" href="pstorage_8c.html#afa78b6a4bd7867f97c12b4ff45e9db22">m_round_val</a> * <a class="code" href="pstorage_8c.html#a331ea60527b8d933979a04a0d1931329">SOC_MAX_WRITE_SIZE</a>);</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;            size          = p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a6b28b458c1dcd9a22f7a14313efefda9">size</a> - offset;</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;            p_data_addr  += offset;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;            storage_addr += (p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a867ff4e9079a79ab5d68f402fed4d3d5">offset</a> + offset);</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;            <span class="keywordflow">if</span> (size &lt; <a class="code" href="pstorage_8c.html#a331ea60527b8d933979a04a0d1931329">SOC_MAX_WRITE_SIZE</a>)</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;            {</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;                retval = sd_flash_write(((uint32_t *)storage_addr),</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;                                        (uint32_t *)p_data_addr,</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;                                        size / <span class="keyword">sizeof</span>(uint32_t));</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;            }</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;            {</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;                retval = sd_flash_write(((uint32_t *)storage_addr),</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                                        (uint32_t *)p_data_addr,</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;                                        <a class="code" href="pstorage_8c.html#a331ea60527b8d933979a04a0d1931329">SOC_MAX_WRITE_SIZE</a> / <span class="keyword">sizeof</span>(uint32_t));</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;            }</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        }</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="group__ps__opcode.html#gaf2ce8b4e460358a23ae82516167df79c">PSTORAGE_CLEAR_OP_CODE</a>:</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;        {</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;            <span class="comment">// Calculate page number before clearing.</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;            uint32_t page_number;</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;            pstorage_size_t block_size =</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                <a class="code" href="pstorage_8c.html#a61d34204e440691235ecf310f87002af">m_app_table</a>[p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#aef41919fc24bd42394ad7a3f06e1ac03">storage_addr</a>.module_id].<a class="code" href="structpstorage__module__table__t.html#aa5f40974b788988ad4b0383b3b6883ca">block_size</a>;</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;            pstorage_size_t block_count =</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                <a class="code" href="pstorage_8c.html#a61d34204e440691235ecf310f87002af">m_app_table</a>[p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#aef41919fc24bd42394ad7a3f06e1ac03">storage_addr</a>.module_id].<a class="code" href="structpstorage__module__table__t.html#a61b52fca7b9d21e4e92565386bd38dc4">block_count</a>;</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;            pstorage_block_t base_address =</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                <a class="code" href="pstorage_8c.html#a61d34204e440691235ecf310f87002af">m_app_table</a>[p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#aef41919fc24bd42394ad7a3f06e1ac03">storage_addr</a>.module_id].<a class="code" href="structpstorage__module__table__t.html#a145ebf201bffca896638196635538b3c">base_id</a>;</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;            <span class="comment">// If the whole module should be cleared.</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;            <span class="keywordflow">if</span> (((base_address == storage_addr) &amp;&amp; (block_size * block_count == p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a6b28b458c1dcd9a22f7a14313efefda9">size</a>)) ||</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                (p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#aef41919fc24bd42394ad7a3f06e1ac03">storage_addr</a>.module_id == <a class="code" href="pstorage_8c.html#a94b4283cfb2fa7e5353d3e45d7033872">RAW_MODE_APP_ID</a>))</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;            {</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;                page_number = ((storage_addr / PSTORAGE_FLASH_PAGE_SIZE) + <a class="code" href="pstorage_8c.html#afa78b6a4bd7867f97c12b4ff45e9db22">m_round_val</a>);</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                retval = sd_flash_page_erase(page_number);</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;            }</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;            <span class="comment">// If one block is to be erased.</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;            {</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;                page_number = (storage_addr / PSTORAGE_FLASH_PAGE_SIZE);</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;                uint32_t head_word_size = (</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;                    storage_addr -</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;                    (page_number * PSTORAGE_FLASH_PAGE_SIZE)</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;                    ) / <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;                uint32_t tail_word_size = (</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;                    ((page_number + 1) * PSTORAGE_FLASH_PAGE_SIZE) -</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;                    (storage_addr + p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a6b28b458c1dcd9a22f7a14313efefda9">size</a>)</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;                    ) / <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;                retval = <a class="code" href="pstorage_8c.html#ga3a61c82e63c372562b71466b441cefc2" title="Function for handling flash accesses when using swap. ">swap_state_process</a>(p_cmd,</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                                            page_number,</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                                            head_word_size,</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;                                            tail_word_size);</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;            }</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        }</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="group__ps__opcode.html#gae66936fc791b79a9f85a7058ea83423a">PSTORAGE_UPDATE_OP_CODE</a>:</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        {</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;            uint32_t page_number = (storage_addr / PSTORAGE_FLASH_PAGE_SIZE);</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;            uint32_t head_word_size = (</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                storage_addr + p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a867ff4e9079a79ab5d68f402fed4d3d5">offset</a> -</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                (page_number * PSTORAGE_FLASH_PAGE_SIZE)</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                ) / <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;            uint32_t tail_word_size = (</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                ((page_number + 1) * PSTORAGE_FLASH_PAGE_SIZE) -</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;                (storage_addr + p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a867ff4e9079a79ab5d68f402fed4d3d5">offset</a> + p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a6b28b458c1dcd9a22f7a14313efefda9">size</a>)</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;                ) / <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;            retval = <a class="code" href="pstorage_8c.html#ga3a61c82e63c372562b71466b441cefc2" title="Function for handling flash accesses when using swap. ">swap_state_process</a>(p_cmd, page_number, head_word_size, tail_word_size);</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        }</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;            <span class="comment">// Should never reach here.</span></div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    }</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    <span class="keywordflow">if</span> (retval == <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>)</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    {</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;        <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a18edda1bb75cef5bb6ecd979b970b9f4">flash_access</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    }</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    <span class="keywordflow">return</span> retval;</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga544e69fa09540f4db68d8a144a963310"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void cmd_queue_element_init </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>index</em>)</td><td></td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initializes command queue element. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">index</td><td>Element index being initialized. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00267">267</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

<p>References <a class="el" href="pstorage__mod_8c_source.html#l00216">cmd_queue_t::cmd</a>, <a class="el" href="pstorage_8c_source.html#l00024">INVALID_OPCODE</a>, <a class="el" href="pstorage__mod_8c_source.html#l00196">cmd_queue_element_t::offset</a>, <a class="el" href="pstorage__mod_8c_source.html#l00194">cmd_queue_element_t::op_code</a>, <a class="el" href="pstorage__mod_8c_source.html#l00198">cmd_queue_element_t::p_data_addr</a>, <a class="el" href="pstorage__mod_8c_source.html#l00195">cmd_queue_element_t::size</a>, and <a class="el" href="pstorage__mod_8c_source.html#l00197">cmd_queue_element_t::storage_addr</a>.</p>
<div class="fragment"><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;{</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <span class="comment">// Internal function and checks on range of index can be avoided.</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a25793c5153d0cbe87bf12d48651aed0b">cmd</a>[index].<a class="code" href="structcmd__queue__element__t.html#a52f5d121921fededbdbea9127fc7b62b">op_code</a>                = <a class="code" href="pstorage_8c.html#ae8a964fad9f97467ca7fc24e214a9e01">INVALID_OPCODE</a>;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a25793c5153d0cbe87bf12d48651aed0b">cmd</a>[index].<a class="code" href="structcmd__queue__element__t.html#a6b28b458c1dcd9a22f7a14313efefda9">size</a>                   = 0;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a25793c5153d0cbe87bf12d48651aed0b">cmd</a>[index].<a class="code" href="structcmd__queue__element__t.html#aef41919fc24bd42394ad7a3f06e1ac03">storage_addr</a>.module_id = PSTORAGE_MAX_APPLICATIONS;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a25793c5153d0cbe87bf12d48651aed0b">cmd</a>[index].<a class="code" href="structcmd__queue__element__t.html#aef41919fc24bd42394ad7a3f06e1ac03">storage_addr</a>.block_id  = 0;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a25793c5153d0cbe87bf12d48651aed0b">cmd</a>[index].<a class="code" href="structcmd__queue__element__t.html#a65b61e75a076b291e7e2defa91d7df80">p_data_addr</a>            = NULL;</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a25793c5153d0cbe87bf12d48651aed0b">cmd</a>[index].<a class="code" href="structcmd__queue__element__t.html#a867ff4e9079a79ab5d68f402fed4d3d5">offset</a>                 = 0;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="gade390fede7a3eff9869a7850a6b53c02"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void cmd_queue_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initializes command queue. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00282">282</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

<p>References <a class="el" href="pstorage_8c_source.html#l00267">cmd_queue_element_init()</a>, <a class="el" href="pstorage__mod_8c_source.html#l00214">cmd_queue_t::count</a>, <a class="el" href="pstorage__mod_8c_source.html#l00215">cmd_queue_t::flash_access</a>, <a class="el" href="pstorage_8c_source.html#l00223">m_round_val</a>, <a class="el" href="pstorage_8c_source.html#l00225">m_swap_state</a>, <a class="el" href="pstorage__mod_8c_source.html#l00213">cmd_queue_t::rp</a>, and <a class="el" href="pstorage__mod_8c_source.html#l00144">STATE_INIT</a>.</p>
<div class="fragment"><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;{</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    uint32_t cmd_index;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <a class="code" href="pstorage_8c.html#afa78b6a4bd7867f97c12b4ff45e9db22">m_round_val</a>              = 0;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a>             = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca98d2a2153b4ae0445fa0b114d65b94d9">STATE_INIT</a>;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a31aabaf2a8bf00cb533484429f9c71ae">rp</a>           = 0;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a20302e2c99a60d3f612dba57e3f6333b">count</a>        = 0;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a18edda1bb75cef5bb6ecd979b970b9f4">flash_access</a> = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="keywordflow">for</span> (cmd_index = 0; cmd_index &lt; PSTORAGE_CMD_QUEUE_SIZE; cmd_index++)</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    {</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        <a class="code" href="pstorage_8c.html#ga544e69fa09540f4db68d8a144a963310" title="Initializes command queue element. ">cmd_queue_element_init</a>(cmd_index);</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    }</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga161eddb644ed938b9341102ac2237844"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static uint32_t cmd_queue_enqueue </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>opcode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">pstorage_handle_t *&#160;</td>
          <td class="paramname"><em>p_storage_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>p_data_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">pstorage_size_t&#160;</td>
          <td class="paramname"><em>size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">pstorage_size_t&#160;</td>
          <td class="paramname"><em>offset</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Routine to enqueue a flash access operation. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">opcode</td><td>Identifies operation requested to be enqueued. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">p_storage_addr</td><td>Identiifes module and flash address on which operation is requested. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">p_data_addr</td><td>Identifies data address for flash access. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">size</td><td>Size in bytes of data requested for the access operation. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">offset</td><td>Offset within the flash memory block at which operation is requested.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">NRF_SUCCESS</td><td>on success, else an error code indicating reason for failure.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>All paramater check should be performed before requesting in an enqueue. </dd></dl>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00312">312</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

<p>References <a class="el" href="pstorage__mod_8c_source.html#l00216">cmd_queue_t::cmd</a>, <a class="el" href="pstorage_8c_source.html#l00699">cmd_process()</a>, <a class="el" href="pstorage__mod_8c_source.html#l00214">cmd_queue_t::count</a>, <a class="el" href="pstorage__mod_8c_source.html#l00215">cmd_queue_t::flash_access</a>, <a class="el" href="nrf__error_8h_source.html#l00045">NRF_ERROR_BUSY</a>, <a class="el" href="nrf__error_8h_source.html#l00032">NRF_ERROR_NO_MEM</a>, <a class="el" href="nrf__error_8h_source.html#l00028">NRF_SUCCESS</a>, <a class="el" href="pstorage__mod_8c_source.html#l00196">cmd_queue_element_t::offset</a>, <a class="el" href="pstorage__mod_8c_source.html#l00194">cmd_queue_element_t::op_code</a>, <a class="el" href="pstorage__mod_8c_source.html#l00198">cmd_queue_element_t::p_data_addr</a>, <a class="el" href="pstorage__mod_8c_source.html#l00213">cmd_queue_t::rp</a>, <a class="el" href="pstorage__mod_8c_source.html#l00195">cmd_queue_element_t::size</a>, and <a class="el" href="pstorage__mod_8c_source.html#l00197">cmd_queue_element_t::storage_addr</a>.</p>
<div class="fragment"><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;{</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    uint32_t retval;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    uint8_t  write_index = 0;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a20302e2c99a60d3f612dba57e3f6333b">count</a> != PSTORAGE_CMD_QUEUE_SIZE)</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    {</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        <span class="comment">// Enqueue the command if it is queue is not full.</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        write_index = <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a31aabaf2a8bf00cb533484429f9c71ae">rp</a> + <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a20302e2c99a60d3f612dba57e3f6333b">count</a>;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keywordflow">if</span> (write_index &gt;= PSTORAGE_CMD_QUEUE_SIZE)</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        {</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            write_index -= PSTORAGE_CMD_QUEUE_SIZE;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        }</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a25793c5153d0cbe87bf12d48651aed0b">cmd</a>[write_index].<a class="code" href="structcmd__queue__element__t.html#a52f5d121921fededbdbea9127fc7b62b">op_code</a>      = opcode;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a25793c5153d0cbe87bf12d48651aed0b">cmd</a>[write_index].<a class="code" href="structcmd__queue__element__t.html#a65b61e75a076b291e7e2defa91d7df80">p_data_addr</a>  = p_data_addr;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a25793c5153d0cbe87bf12d48651aed0b">cmd</a>[write_index].<a class="code" href="structcmd__queue__element__t.html#aef41919fc24bd42394ad7a3f06e1ac03">storage_addr</a> = (*p_storage_addr);</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;        <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a25793c5153d0cbe87bf12d48651aed0b">cmd</a>[write_index].<a class="code" href="structcmd__queue__element__t.html#a6b28b458c1dcd9a22f7a14313efefda9">size</a>         = size;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a25793c5153d0cbe87bf12d48651aed0b">cmd</a>[write_index].<a class="code" href="structcmd__queue__element__t.html#a867ff4e9079a79ab5d68f402fed4d3d5">offset</a>       = offset;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        retval                                    = <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>;</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a18edda1bb75cef5bb6ecd979b970b9f4">flash_access</a> == <span class="keyword">false</span>)</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        {</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;            retval = <a class="code" href="pstorage_8c.html#ga78a52b91014e89edc2a765f42f792b3f" title="Routine called to actually issue the flash access request to the SoftDevice. ">cmd_process</a>();</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;            <span class="keywordflow">if</span> (retval == <a class="code" href="group__nrf__error.html#ga5d2d8608f6d6a0329f58961a969e946e" title="Busy. ">NRF_ERROR_BUSY</a>)</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;            {</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                <span class="comment">// In case of busy error code, it is possible to attempt to access flash.</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                retval = <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;            }</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        }</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a20302e2c99a60d3f612dba57e3f6333b">count</a>++;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    }</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    {</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        retval = <a class="code" href="group__nrf__error.html#ga7ef4d466b79b31c6325f8b7af5d4f75f" title="No Memory for operation. ">NRF_ERROR_NO_MEM</a>;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    }</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="keywordflow">return</span> retval;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga5026eeb68df47eb0714f063471b14c12"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static uint32_t cmd_queue_dequeue </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Dequeues a command element. </p>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">NRF_SUCCESS</td><td>on success, else an error code indicating reason for failure. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00362">362</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

<p>References <a class="el" href="pstorage_8c_source.html#l00699">cmd_process()</a>, <a class="el" href="pstorage__mod_8c_source.html#l00214">cmd_queue_t::count</a>, <a class="el" href="nrf__error_8h_source.html#l00045">NRF_ERROR_BUSY</a>, and <a class="el" href="nrf__error_8h_source.html#l00028">NRF_SUCCESS</a>.</p>
<div class="fragment"><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;{</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    uint32_t retval;</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    retval = <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>;</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="comment">// If any flash operation is enqueued, schedule.</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="pstorage_8c.html#aa4316c8dd50f357ae5f6b4d5c8c2e85a">m_cmd_queue</a>.<a class="code" href="structcmd__queue__t.html#a20302e2c99a60d3f612dba57e3f6333b">count</a> &gt; 0)</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    {</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        retval = <a class="code" href="pstorage_8c.html#ga78a52b91014e89edc2a765f42f792b3f" title="Routine called to actually issue the flash access request to the SoftDevice. ">cmd_process</a>();</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        <span class="keywordflow">if</span> (retval != <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>)</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        {</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            <span class="comment">// Flash could be accessed by modules other than Bond Manager, hence a busy error is</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            <span class="comment">// acceptable, but any other error needs to be indicated to the bond manager.</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            <span class="keywordflow">if</span> (retval == <a class="code" href="group__nrf__error.html#ga5d2d8608f6d6a0329f58961a969e946e" title="Busy. ">NRF_ERROR_BUSY</a>)</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;            {</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                <span class="comment">// In case of busy error code, it is possible to attempt to access flash.</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                retval = <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            }</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        }</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    }</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    {</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        <span class="comment">// No flash access request pending.</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    }</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordflow">return</span> retval;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga3a61c82e63c372562b71466b441cefc2"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static uint32_t swap_state_process </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structcmd__queue__element__t.html">cmd_queue_element_t</a> *&#160;</td>
          <td class="paramname"><em>p_cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>page_number</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>head_word_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>tail_word_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Function for handling flash accesses when using swap. </p>
<hr/>
<p> | Page | |________________________________________________________| | head | affected body (to be updated or cleared) | tail | |______|__________________________________________|______|</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">p_cmd</td><td>Queue element being processed. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">page_number</td><td>The affected page number. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">head_word_size</td><td>Size of the head in number of words. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tail_word_size</td><td>Size of the tail in number of words.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">NRF_SUCCESS</td><td>on success, else an error code indicating reason for failure. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00545">545</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

<p>References <a class="el" href="pstorage_8c_source.html#l00225">m_swap_state</a>, <a class="el" href="nrf__error_8h_source.html#l00031">NRF_ERROR_INTERNAL</a>, <a class="el" href="nrf__error_8h_source.html#l00028">NRF_SUCCESS</a>, <a class="el" href="pstorage__mod_8c_source.html#l00194">cmd_queue_element_t::op_code</a>, <a class="el" href="pstorage__mod_8c_source.html#l00198">cmd_queue_element_t::p_data_addr</a>, <a class="el" href="pstorage_8h_source.html#l00044">PSTORAGE_CLEAR_OP_CODE</a>, <a class="el" href="pstorage__mod_8c_source.html#l00195">cmd_queue_element_t::size</a>, <a class="el" href="pstorage__mod_8c_source.html#l00151">STATE_COMPLETE</a>, <a class="el" href="pstorage__mod_8c_source.html#l00146">STATE_DATA_ERASE</a>, <a class="el" href="pstorage__mod_8c_source.html#l00145">STATE_DATA_TO_SWAP_WRITE</a>, <a class="el" href="pstorage__mod_8c_source.html#l00147">STATE_HEAD_RESTORE</a>, <a class="el" href="pstorage__mod_8c_source.html#l00144">STATE_INIT</a>, <a class="el" href="pstorage__mod_8c_source.html#l00149">STATE_NEW_BODY_WRITE</a>, <a class="el" href="pstorage__mod_8c_source.html#l00150">STATE_SWAP_ERASE</a>, and <a class="el" href="pstorage__mod_8c_source.html#l00148">STATE_TAIL_RESTORE</a>.</p>
<div class="fragment"><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;{</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    uint32_t retval = <a class="code" href="group__nrf__error.html#gadf8b0c33ea15352808e5ac7f69c2be8a" title="Internal Error. ">NRF_ERROR_INTERNAL</a>;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    <span class="comment">// Adjust entry point to state machine if needed. When we update has no head or tail its</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    <span class="comment">// no need for using the swap.</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> == <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca98d2a2153b4ae0445fa0b114d65b94d9">STATE_INIT</a>)</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    {</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        <span class="keywordflow">if</span> ((head_word_size == 0) &amp;&amp; (tail_word_size == 0))</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        {</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;            <span class="comment">// Only skip swap usage if the new data fills a whole flash page.</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca8bf8e397bd25d4a5b8f06e844026b616">STATE_DATA_ERASE</a>;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;        }</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        {</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;            <span class="comment">// Else start backing up application data to swap.</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;            <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca38dc08c7fee1ad64f0a62788c9c9a8c1">STATE_DATA_TO_SWAP_WRITE</a>;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        }</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    }</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    <span class="keywordflow">switch</span> (<a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a>)</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    {</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca38dc08c7fee1ad64f0a62788c9c9a8c1">STATE_DATA_TO_SWAP_WRITE</a>:</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;            <span class="comment">// Backup previous content into swap page.</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;            retval = sd_flash_write((uint32_t *)(PSTORAGE_SWAP_ADDR),</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                                    (uint32_t *)(page_number * PSTORAGE_FLASH_PAGE_SIZE),</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                                    PSTORAGE_FLASH_PAGE_SIZE / <span class="keyword">sizeof</span>(uint32_t));</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;            <span class="keywordflow">if</span> (retval == <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>)</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;            {</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca8bf8e397bd25d4a5b8f06e844026b616">STATE_DATA_ERASE</a>;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;            }</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca8bf8e397bd25d4a5b8f06e844026b616">STATE_DATA_ERASE</a>:</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;            <span class="comment">// Clear the application data page.</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;            retval = sd_flash_page_erase(page_number);</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;            <span class="keywordflow">if</span> (retval == <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>)</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;            {</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                <span class="keywordflow">if</span> (head_word_size == 0)</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                {</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                    <span class="keywordflow">if</span> (tail_word_size == 0)</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                    {</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;                        <span class="keywordflow">if</span> (p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a52f5d121921fededbdbea9127fc7b62b">op_code</a> == <a class="code" href="group__ps__opcode.html#gaf2ce8b4e460358a23ae82516167df79c">PSTORAGE_CLEAR_OP_CODE</a>)</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;                        {</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                            <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca79ae1582c50ffdc26c332345ede75d7c">STATE_COMPLETE</a>;</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;                        }</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                        {</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                            <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ecae7960498d64521690dd52b61ff4ab2d5">STATE_NEW_BODY_WRITE</a>;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                        }</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                    }</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;                    {</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;                        <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca47083903ebe8137c35d40ffc57ae355e">STATE_TAIL_RESTORE</a>;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                    }</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                }</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                {</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                    <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ecaf54478673392a43ef3c887b3db89b0a9">STATE_HEAD_RESTORE</a>;</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;                }</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;            }</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ecaf54478673392a43ef3c887b3db89b0a9">STATE_HEAD_RESTORE</a>:</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;            <span class="comment">// Restore head from swap to application data page.</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            retval = sd_flash_write((uint32_t *)(page_number * PSTORAGE_FLASH_PAGE_SIZE),</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                                    (uint32_t *)PSTORAGE_SWAP_ADDR,</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                                    head_word_size);</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;            <span class="keywordflow">if</span> (retval == <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>)</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;            {</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                <span class="keywordflow">if</span> (tail_word_size == 0)</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                {</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                    <span class="keywordflow">if</span> (p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a52f5d121921fededbdbea9127fc7b62b">op_code</a> == <a class="code" href="group__ps__opcode.html#gaf2ce8b4e460358a23ae82516167df79c">PSTORAGE_CLEAR_OP_CODE</a>)</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                    {</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                        <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca240812b0e713ea6c50fe47cfdb2528b4">STATE_SWAP_ERASE</a>;</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                    }</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                    {</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                        <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ecae7960498d64521690dd52b61ff4ab2d5">STATE_NEW_BODY_WRITE</a>;</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                    }</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;                }</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                {</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                    <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca47083903ebe8137c35d40ffc57ae355e">STATE_TAIL_RESTORE</a>;</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                }</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;            }</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca47083903ebe8137c35d40ffc57ae355e">STATE_TAIL_RESTORE</a>:</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            <span class="comment">// Restore tail from swap to application data page.</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;            retval = sd_flash_write((uint32_t *)((page_number * PSTORAGE_FLASH_PAGE_SIZE) +</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                                                 (head_word_size * <span class="keyword">sizeof</span>(uint32_t)) +</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                                                 p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a6b28b458c1dcd9a22f7a14313efefda9">size</a>),</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                                    (uint32_t *)(PSTORAGE_SWAP_ADDR +</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                                                 (head_word_size * <span class="keyword">sizeof</span>(uint32_t)) +</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                                                 p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a6b28b458c1dcd9a22f7a14313efefda9">size</a>),</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                                    tail_word_size);</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;            <span class="keywordflow">if</span> (retval == <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>)</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            {</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                <span class="keywordflow">if</span> (p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a52f5d121921fededbdbea9127fc7b62b">op_code</a> == <a class="code" href="group__ps__opcode.html#gaf2ce8b4e460358a23ae82516167df79c">PSTORAGE_CLEAR_OP_CODE</a>)</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                {</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                    <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca240812b0e713ea6c50fe47cfdb2528b4">STATE_SWAP_ERASE</a>;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                }</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                {</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                    <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ecae7960498d64521690dd52b61ff4ab2d5">STATE_NEW_BODY_WRITE</a>;</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                }</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;            }</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ecae7960498d64521690dd52b61ff4ab2d5">STATE_NEW_BODY_WRITE</a>:</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;            <span class="comment">// Write new data (body) to application data page.</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;            retval = sd_flash_write((uint32_t *)((page_number * PSTORAGE_FLASH_PAGE_SIZE) +</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                                                 (head_word_size * <span class="keyword">sizeof</span>(uint32_t))),</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                                    (uint32_t *)p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a65b61e75a076b291e7e2defa91d7df80">p_data_addr</a>,</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                                    p_cmd-&gt;<a class="code" href="structcmd__queue__element__t.html#a6b28b458c1dcd9a22f7a14313efefda9">size</a> / <span class="keyword">sizeof</span>(uint32_t));</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;            <span class="keywordflow">if</span> (retval == <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>)</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;            {</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                <span class="keywordflow">if</span> ((head_word_size == 0) &amp;&amp; (tail_word_size == 0))</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;                {</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                    <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca79ae1582c50ffdc26c332345ede75d7c">STATE_COMPLETE</a>;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                }</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;                {</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;                    <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca240812b0e713ea6c50fe47cfdb2528b4">STATE_SWAP_ERASE</a>;</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;                }</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;            }</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca240812b0e713ea6c50fe47cfdb2528b4">STATE_SWAP_ERASE</a>:</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;            <span class="comment">// Clear the swap page for subsequent use.</span></div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;            retval = sd_flash_page_erase(PSTORAGE_SWAP_ADDR / PSTORAGE_FLASH_PAGE_SIZE);</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;            <span class="keywordflow">if</span> (retval == <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>)</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;            {</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                <a class="code" href="pstorage_8c.html#a424c25c247944aad095274cfd4429646">m_swap_state</a> = <a class="code" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03eca79ae1582c50ffdc26c332345ede75d7c">STATE_COMPLETE</a>;</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;            }</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    }</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    <span class="keywordflow">return</span> retval;</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a class="anchor" id="aa4316c8dd50f357ae5f6b4d5c8c2e85a"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structcmd__queue__t.html">cmd_queue_t</a> m_cmd_queue</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Flash operation request queue. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00220">220</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

</div>
</div>
<a class="anchor" id="aeb0ea5d8898efee3644c43b2206d4a57"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">pstorage_size_t m_next_app_instance</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Points to the application module instance that can be allocated next. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00221">221</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

</div>
</div>
<a class="anchor" id="a2d3292c0e300f3deb4b05d9fe6354779"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t m_next_page_addr</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Points to the flash address that can be allocated to a module next, this is needed as blocks of a module can span across flash pages. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00222">222</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

</div>
</div>
<a class="anchor" id="afa78b6a4bd7867f97c12b4ff45e9db22"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">pstorage_size_t m_round_val</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Round value for multiple round operations. For erase operations, the round value will contain current round counter which is identical to number of pages erased. For store operations, the round value contains current round of operation * SOC_MAX_WRITE_SIZE to ensure each store to the SoC Flash API is within the SoC limit. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00223">223</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

</div>
</div>
<a class="anchor" id="a7e99e7d02e854ee64a37440c60bf641e"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool m_module_initialized = false</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Flag for checking if module has been initialized. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00224">224</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

</div>
</div>
<a class="anchor" id="a424c25c247944aad095274cfd4429646"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="pstorage__mod_8c.html#a69fa0c3173bb59cc6a4907cb18de03ec">swap_backup_state_t</a> m_swap_state</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Swap page state. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00225">225</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

</div>
</div>
<a class="anchor" id="a61d34204e440691235ecf310f87002af"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structpstorage__module__table__t.html">pstorage_module_table_t</a> m_app_table[PSTORAGE_MAX_APPLICATIONS]</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Registered application information table. </p>

<p>Definition at line <a class="el" href="pstorage_8c_source.html#l00228">228</a> of file <a class="el" href="pstorage_8c_source.html">pstorage.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_91b59e8f2130a1dd874d9e7c771a276d.html">components</a></li><li class="navelem"><a class="el" href="dir_25feff8c79d761619a806253cfa07b5b.html">drivers_nrf</a></li><li class="navelem"><a class="el" href="dir_b7195a6f1300699f57559ae83b955b8b.html">pstorage</a></li><li class="navelem"><a class="el" href="pstorage_8c.html">pstorage.c</a></li>
    <li class="footer">Generated on Mon Apr 13 2015 11:33:10 for nRF51822 Beacon Firmware Documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
