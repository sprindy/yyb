<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>nRF51822 Beacon Firmware Documentation: components/libraries/bootloader_dfu/bootloader_util_arm.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF51822 Beacon Firmware Documentation
   &#160;<span id="projectnumber">v1.1.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('bootloader__util__arm_8c.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">bootloader_util_arm.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="bootloader__util_8h_source.html">bootloader_util.h</a>&quot;</code><br/>
<code>#include &lt;stdint.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
</div>
<p><a href="bootloader__util__arm_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a2e1ed9c048752af0a9b7984d4ec5d799"><td class="memItemLeft" align="right" valign="top">static __asm void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bootloader__util__arm_8c.html#a2e1ed9c048752af0a9b7984d4ec5d799">bootloader_util_reset</a> (uint32_t start_addr)</td></tr>
<tr class="memdesc:a2e1ed9c048752af0a9b7984d4ec5d799"><td class="mdescLeft">&#160;</td><td class="mdescRight">Function for aborting current handler mode and jump to to other application/bootloader.  <a href="#a2e1ed9c048752af0a9b7984d4ec5d799">More...</a><br/></td></tr>
<tr class="separator:a2e1ed9c048752af0a9b7984d4ec5d799"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga1cae97837343b3feb5ff2f5dc5d3ed90"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nrf__bootloader__util.html#ga1cae97837343b3feb5ff2f5dc5d3ed90">bootloader_util_app_start</a> (uint32_t start_addr)</td></tr>
<tr class="memdesc:ga1cae97837343b3feb5ff2f5dc5d3ed90"><td class="mdescLeft">&#160;</td><td class="mdescRight">Function for starting the application (or bootloader) at the provided address.  <a href="group__nrf__bootloader__util.html#ga1cae97837343b3feb5ff2f5dc5d3ed90">More...</a><br/></td></tr>
<tr class="separator:ga1cae97837343b3feb5ff2f5dc5d3ed90"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a2e1ed9c048752af0a9b7984d4ec5d799"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static __asm void bootloader_util_reset </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>start_addr</em>)</td><td></td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Function for aborting current handler mode and jump to to other application/bootloader. </p>
<p>This functions will use the address provide (reset handler) to be executed after handler mode is exited. It creates an initial stack to ensure correct reset behavior when the reset handler is executed. See <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0552a/Babefdjc.html">http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0552a/Babefdjc.html</a></p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">reset_handler</td><td>Address of the reset handler to be executed when handler mode exits.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>This function must never be called directly from 'C' but is intended only to be used from <a class="el" href="bootloader__util__arm_8c.html#a2e1ed9c048752af0a9b7984d4ec5d799">bootloader_util_reset</a>. This function will never return but issue a reset into provided address. Function for aborting current application/bootloader jump to to other app/bootloader.</dd></dl>
<p>This functions will use the address provide to swap the stack pointer and then load the address of the reset handler to be executed. It will check current system mode (thread/handler) and if in thread mode it will reset into other application. If in handler mode isr_abort will be executed to ensure correct exit of handler mode and jump into reset handler of other application.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">start_addr</td><td>Start address of other application. This address must point to the initial stack pointer of the application.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>This function will never return but issue a reset into provided application. </dd></dl>

<p>Definition at line <a class="el" href="bootloader__util__arm_8c_source.html#l00048">48</a> of file <a class="el" href="bootloader__util__arm_8c_source.html">bootloader_util_arm.c</a>.</p>

<p>References <a class="el" href="main_8c_source.html#l00858">main()</a>.</p>
<div class="fragment"><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;{</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;MASK_ONES       EQU 0xFFFFFFFF  ; Ones, to be loaded into <span class="keyword">register</span> as <span class="keywordflow">default</span> value before reset.</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;MASK_ZEROS      EQU 0x00000000  ; Zeros, to be loaded into <span class="keyword">register</span> as <span class="keywordflow">default</span> value before reset.</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;xPSR_RESET      EQU 0x21000000  ; Default value of xPSR after System Reset.</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;EXC_RETURN_CMD  EQU 0xFFFFFFF9  ; EXC_RETURN <span class="keywordflow">for</span> ARM Cortex. When loaded to PC the current interrupt service routine (handler mode) willl exit and the stack will be popped. Execution will <span class="keywordflow">continue</span> in thread mode.</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    LDR   R5, [R0]              ; Get App initial MSP <span class="keywordflow">for</span> bootloader.</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    MSR   MSP, R5               ; Set the <a class="code" href="group__ble__app__beacon__main.html#ga840291bc02cba5474a4cb46a9b9566fe" title="Function for application main entry. ">main</a> stack pointer to the applications MSP.</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    LDR   R6, [R0, #0x04]       ; Load Reset handler into <span class="keyword">register</span> 6.</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    LDR   R2, =MASK_ZEROS       ; Load zeros to R2</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    MRS   R3, IPSR              ; Load IPSR to R3 to check <span class="keywordflow">for</span> handler or thread mode </div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    CMP   R2, R3                ; Compare, <span class="keywordflow">if</span> 0 then we are in thread mode and can <span class="keywordflow">continue</span> to reset handler of bootloader</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    MOV   R0, R6</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    BNE   isr_abort             ; If not zero we need to exit current ISR and jump to reset handler of bootloader</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    LDR   R4, =MASK_ONES        ; Load ones to R4 to be placed in Link Register.</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    MOV   LR, R4                ; Clear the link <span class="keyword">register</span> and set to ones to ensure no <span class="keywordflow">return</span>.</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    BX    R6                    ; Branch to reset handler of bootloader</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;isr_abort</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    LDR   R4,=MASK_ONES         ; Fill with ones before jumping to reset handling. We be popped as R12 when exiting ISR (Cleaning up the registers).</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    LDR   R5,=MASK_ONES         ; Fill with ones before jumping to reset handling. We be popped as LR when exiting ISR. Ensures no <span class="keywordflow">return</span> to application.</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    MOV   R6, R0                ; Move address of reset handler to R6. Will be popped as PC when exiting ISR. Ensures the reset handler will be executed when exist ISR.</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    LDR   R7,=xPSR_RESET        ; Move reset value of xPSR to R7. Will be popped as xPSR when exiting ISR.</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    PUSH  {r4-r7}               ; Push everything to <span class="keyword">new</span> stack to allow interrupt handler to fetch it on exiting the ISR.</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    LDR   R4,=MASK_ZEROS        ; Fill with zeros before jumping to reset handling. We be popped as R0 when exiting ISR (Cleaning up of the registers).</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    LDR   R5,=MASK_ZEROS        ; Fill with zeros before jumping to reset handling. We be popped as R1 when exiting ISR (Cleaning up of the registers).</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    LDR   R6,=MASK_ZEROS        ; Fill with zeros before jumping to reset handling. We be popped as R2 when exiting ISR (Cleaning up of the registers).</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    LDR   R7,=MASK_ZEROS        ; Fill with zeros before jumping to reset handling. We be popped as R3 when exiting ISR (Cleaning up of the registers).</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    PUSH  {r4-r7}               ; Push zeros (R4-R7) to stack to prepare for exiting the interrupt routine.</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    LDR   R0,=EXC_RETURN_CMD    ; Load the execution return command into register.</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    BX    R0                    ; No return - Handler mode will be exited. Stack will be popped and execution will continue in reset handler initializing other application.</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    ALIGN</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_91b59e8f2130a1dd874d9e7c771a276d.html">components</a></li><li class="navelem"><a class="el" href="dir_cba6476b77d20c46e2df1d037244e991.html">libraries</a></li><li class="navelem"><a class="el" href="dir_d43a1a39d1eb8b384089a92cd78d95d5.html">bootloader_dfu</a></li><li class="navelem"><a class="el" href="bootloader__util__arm_8c.html">bootloader_util_arm.c</a></li>
    <li class="footer">Generated on Mon Apr 13 2015 11:33:10 for nRF51822 Beacon Firmware Documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
