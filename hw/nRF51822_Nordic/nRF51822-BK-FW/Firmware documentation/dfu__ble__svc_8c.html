<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>nRF51822 Beacon Firmware Documentation: nrf51_beacon/ble_app_beacon_dfu/bootloader/dfu_ble_svc.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF51822 Beacon Firmware Documentation
   &#160;<span id="projectnumber">v1.1.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dfu__ble__svc_8c.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">dfu_ble_svc.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="dfu__ble__svc_8h_source.html">dfu_ble_svc.h</a>&quot;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="nrf__error_8h_source.html">nrf_error.h</a>&quot;</code><br/>
<code>#include &quot;crc16.h&quot;</code><br/>
</div>
<p><a href="dfu__ble__svc_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:afb8e81c78c2515beb3394a574774bd07"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structdfu__ble__peer__data__t.html">dfu_ble_peer_data_t</a> <br class="typebreak"/>
<a class="el" href="dfu__app__handler_8c.html#a859a4a7a2689f8afe137e11b6af7e305">m_peer_data</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dfu__ble__svc_8c.html#afb8e81c78c2515beb3394a574774bd07">__attribute__</a> ((section(&quot;NoInit&quot;), zero_init))</td></tr>
<tr class="separator:afb8e81c78c2515beb3394a574774bd07"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7bb49a0694829231da7cc6e6b79e7952"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dfu__ble__svc_8c.html#a7bb49a0694829231da7cc6e6b79e7952">dfu_ble_set_peer_data</a> (<a class="el" href="structdfu__ble__peer__data__t.html">dfu_ble_peer_data_t</a> *p_peer_data)</td></tr>
<tr class="memdesc:a7bb49a0694829231da7cc6e6b79e7952"><td class="mdescLeft">&#160;</td><td class="mdescRight">Function for setting the peer data from application in bootloader before reset.  <a href="#a7bb49a0694829231da7cc6e6b79e7952">More...</a><br/></td></tr>
<tr class="separator:a7bb49a0694829231da7cc6e6b79e7952"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a027b8ac90ecfd4f3186f35e9443d4667"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dfu__ble__svc_8c.html#a027b8ac90ecfd4f3186f35e9443d4667">C_SVC_Handler</a> (uint8_t svc_num, uint32_t *svc_args)</td></tr>
<tr class="memdesc:a027b8ac90ecfd4f3186f35e9443d4667"><td class="mdescLeft">&#160;</td><td class="mdescRight">Function for handling second stage of SuperVisor Calls (SVC).  <a href="#a027b8ac90ecfd4f3186f35e9443d4667">More...</a><br/></td></tr>
<tr class="separator:a027b8ac90ecfd4f3186f35e9443d4667"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a37a51408555bf2a31f8e00a7ec229b7a"><td class="memItemLeft" align="right" valign="top">__asm void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dfu__ble__svc_8c.html#a37a51408555bf2a31f8e00a7ec229b7a">SVC_Handler</a> (void)</td></tr>
<tr class="memdesc:a37a51408555bf2a31f8e00a7ec229b7a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Function for handling the first stage of SuperVisor Calls (SVC) in assembly.  <a href="#a37a51408555bf2a31f8e00a7ec229b7a">More...</a><br/></td></tr>
<tr class="separator:a37a51408555bf2a31f8e00a7ec229b7a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaae1ae9e244a40aeee3537eeb9e7d455e"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nrf__dfu__ble__svc__internal.html#gaae1ae9e244a40aeee3537eeb9e7d455e">dfu_ble_get_peer_data</a> (<a class="el" href="structdfu__ble__peer__data__t.html">dfu_ble_peer_data_t</a> *p_peer_data)</td></tr>
<tr class="memdesc:gaae1ae9e244a40aeee3537eeb9e7d455e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Internal bootloader/DFU function for retrieving peer data provided from application.  <a href="group__nrf__dfu__ble__svc__internal.html#gaae1ae9e244a40aeee3537eeb9e7d455e">More...</a><br/></td></tr>
<tr class="separator:gaae1ae9e244a40aeee3537eeb9e7d455e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="afb8e81c78c2515beb3394a574774bd07"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static uint16_t m_peer_data_crc __attribute__ </td>
          <td>(</td>
          <td class="paramtype">(section(&quot;NoInit&quot;), zero_init)&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>This variable should be placed in a non initialized RAM section in order to be valid upon soft reset from application into bootloader.</p>
<p>CRC variable to ensure the integrity of the peer data provided. </p>

</div>
</div>
<a class="anchor" id="a7bb49a0694829231da7cc6e6b79e7952"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static uint32_t dfu_ble_set_peer_data </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdfu__ble__peer__data__t.html">dfu_ble_peer_data_t</a> *&#160;</td>
          <td class="paramname"><em>p_peer_data</em>)</td><td></td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Function for setting the peer data from application in bootloader before reset. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">p_peer_data</td><td>Pointer to the peer data containing keys for the connection. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="dfu__ble__svc_8c_source.html#l00026">26</a> of file <a class="el" href="dfu__ble__svc_8c_source.html">dfu_ble_svc.c</a>.</p>

<p>References <a class="el" href="dfu__app__handler_8c_source.html#l00028">m_peer_data</a>, <a class="el" href="nrf__error_8h_source.html#l00042">NRF_ERROR_NULL</a>, and <a class="el" href="nrf__error_8h_source.html#l00028">NRF_SUCCESS</a>.</p>
<div class="fragment"><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;{</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    <span class="keywordflow">if</span> (p_peer_data == NULL)</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    {</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="group__nrf__error.html#gaf6e08e45224ec612e6c95660eb1bcfa0" title="Null Pointer. ">NRF_ERROR_NULL</a>;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    }</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    uint32_t src = (uint32_t)p_peer_data;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    uint32_t dst = (uint32_t)&amp;<a class="code" href="dfu__app__handler_8c.html#a859a4a7a2689f8afe137e11b6af7e305">m_peer_data</a>;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    uint32_t len = dst - src;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    <span class="keywordflow">if</span> (src == dst)</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    {</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;        <span class="comment">// Do nothing as source and destination are identical, just calculate crc below.</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    }</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt; <span class="keyword">sizeof</span>(<a class="code" href="structdfu__ble__peer__data__t.html" title="DFU Peer data structure. ">dfu_ble_peer_data_t</a>))</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    {</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        uint32_t i = 0;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        dst += <span class="keyword">sizeof</span>(<a class="code" href="structdfu__ble__peer__data__t.html" title="DFU Peer data structure. ">dfu_ble_peer_data_t</a>);</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;        src += <span class="keyword">sizeof</span>(<a class="code" href="structdfu__ble__peer__data__t.html" title="DFU Peer data structure. ">dfu_ble_peer_data_t</a>);</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;        <span class="comment">// Copy byte wise backwards when facing overlapping structures.</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;        <span class="keywordflow">while</span> (i++ &lt;= <span class="keyword">sizeof</span>(<a class="code" href="structdfu__ble__peer__data__t.html" title="DFU Peer data structure. ">dfu_ble_peer_data_t</a>))</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        {</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;            *((uint8_t *)dst--) = *((uint8_t *)src--);</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;        }</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    }</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    {</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        memcpy((<span class="keywordtype">void</span> *)dst, (<span class="keywordtype">void</span> *)src, <span class="keyword">sizeof</span>(<a class="code" href="structdfu__ble__peer__data__t.html" title="DFU Peer data structure. ">dfu_ble_peer_data_t</a>));</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    }</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    m_peer_data_crc = crc16_compute((uint8_t *)&amp;<a class="code" href="dfu__app__handler_8c.html#a859a4a7a2689f8afe137e11b6af7e305">m_peer_data</a>, <span class="keyword">sizeof</span>(<a class="code" href="dfu__app__handler_8c.html#a859a4a7a2689f8afe137e11b6af7e305">m_peer_data</a>), NULL);</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a027b8ac90ecfd4f3186f35e9443d4667"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void C_SVC_Handler </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>svc_num</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t *&#160;</td>
          <td class="paramname"><em>svc_args</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Function for handling second stage of SuperVisor Calls (SVC). </p>
<p>The function will use svc_num to call the corresponding SVC function.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">svc_num</td><td>SVC number for function to be executed </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">svc_args</td><td>Argument list for the SVC.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>This function returns the error value of the SVC return. For further details, please refer to the details of the SVC implementation itself. <a class="el" href="group__nrf__error.html#gacee74578161456da0759c7b80f55d2e0">NRF_ERROR_SVC_HANDLER_MISSING</a> is returned if no SVC handler is implemented for the provided svc_num. </dd></dl>

<p>Definition at line <a class="el" href="dfu__ble__svc_8c_source.html#l00077">77</a> of file <a class="el" href="dfu__ble__svc_8c_source.html">dfu_ble_svc.c</a>.</p>

<p>References <a class="el" href="dfu__ble__svc_8c_source.html#l00026">dfu_ble_set_peer_data()</a>, <a class="el" href="dfu__ble__svc_8h_source.html#l00048">DFU_BLE_SVC_SET_PEER_DATA</a>, and <a class="el" href="nrf__error_8h_source.html#l00029">NRF_ERROR_SVC_HANDLER_MISSING</a>.</p>
<div class="fragment"><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;{</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="keywordflow">switch</span> (svc_num)</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    {</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="group__nrf__dfu__ble__svc.html#ggab61a9eaf497f22e66f7a0f76d8203133a343827596c1f6effeaf0ff0149cb5734">DFU_BLE_SVC_SET_PEER_DATA</a>:</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;            svc_args[0] = <a class="code" href="dfu__ble__svc_8c.html#a7bb49a0694829231da7cc6e6b79e7952" title="Function for setting the peer data from application in bootloader before reset. ">dfu_ble_set_peer_data</a>((<a class="code" href="structdfu__ble__peer__data__t.html" title="DFU Peer data structure. ">dfu_ble_peer_data_t</a> *) svc_args[0]);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;            svc_args[0] = <a class="code" href="group__nrf__error.html#gacee74578161456da0759c7b80f55d2e0" title="SVC handler is missing. ">NRF_ERROR_SVC_HANDLER_MISSING</a>;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    }</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a37a51408555bf2a31f8e00a7ec229b7a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__asm void SVC_Handler </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Function for handling the first stage of SuperVisor Calls (SVC) in assembly. </p>
<p>The function will use the link register (LR) to determine the stack (PSP or MSP) to be used and then decode the SVC number afterwards. After decoding the SVC number then <a class="el" href="dfu__ble__svc_8c.html#a027b8ac90ecfd4f3186f35e9443d4667">C_SVC_Handler</a> is called for further processing of the SVC. </p>

<p>Definition at line <a class="el" href="dfu__ble__svc_8c_source.html#l00099">99</a> of file <a class="el" href="dfu__ble__svc_8c_source.html">dfu_ble_svc.c</a>.</p>

<p>References <a class="el" href="dfu__ble__svc_8c_source.html#l00077">C_SVC_Handler()</a>.</p>
<div class="fragment"><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;{</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;EXC_RETURN_CMD_PSP  EQU 0xFFFFFFFD  ; EXC_RETURN <span class="keyword">using</span> PSP <span class="keywordflow">for</span> ARM Cortex. If Link <span class="keyword">register</span> contains <span class="keyword">this</span> value it indicates the PSP was used before the SVC, otherwise the MSP was used.</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    IMPORT <a class="code" href="dfu__ble__svc_8c.html#a027b8ac90ecfd4f3186f35e9443d4667" title="Function for handling second stage of SuperVisor Calls (SVC). ">C_SVC_Handler</a></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    LDR   R0, =EXC_RETURN_CMD_PSP   ; Load the EXC_RETURN into R0 to be able to compare against LR to determine stack pointer used. </div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    CMP   R0, LR                    ; Compare the link <span class="keyword">register</span> with R0. If equal then PSP was used, otherwise MSP was used before SVC.</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    BNE   UseMSP                    ; Branch to code fetching SVC arguments <span class="keyword">using</span> MSP.</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    MRS   R1, PSP                   ; Move PSP into R1.</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    B     Call_C_SVC_Handler        ; Branch to Call_C_SVC_Handler below.</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;UseMSP</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    MRS   R1, MSP                   ; MSP was used, therefore Move MSP into R1.</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;Call_C_SVC_Handler</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    LDR   R0, [R1, #24]             ; The arguments <span class="keywordflow">for</span> the SVC was stacked. R1 contains Stack Pointer, the values stacked before SVC are R0, R1, R2, R3, R12, LR, PC (Return address), xPSR. </div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;                                    ; R1 contains current SP so the PC of the stacked frame is at SP + 6 words (24 bytes). We load the PC into R0.</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    SUBS  R0, #2                    ; The PC before the SVC is in R0. We subtract 2 to <span class="keyword">get</span> the address prior to the instruction executed where the SVC number is located.</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    LDRB  R0, [R0]                  ; SVC instruction low octet: Load the byte at the address before the PC to fetch the SVC number.</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    LDR   R2, =<a class="code" href="dfu__ble__svc_8c.html#a027b8ac90ecfd4f3186f35e9443d4667" title="Function for handling second stage of SuperVisor Calls (SVC). ">C_SVC_Handler</a>        ; Load address of C implementation of SVC handler.</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    BX    R2                        ; Branch to C implementation of SVC handler. R0 is now the SVC number, R1 is the StackPointer where the arguments (R0-R3) of the original SVC are located.</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    ALIGN</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_753c3ab39a1e65d5d58171958880fde4.html">nrf51_beacon</a></li><li class="navelem"><a class="el" href="dir_c9f0536aaef75a19cc06891f126dc56e.html">ble_app_beacon_dfu</a></li><li class="navelem"><a class="el" href="dir_08e6c3fdddf01ad012396708f4ddcb12.html">bootloader</a></li><li class="navelem"><a class="el" href="dfu__ble__svc_8c.html">dfu_ble_svc.c</a></li>
    <li class="footer">Generated on Mon Apr 13 2015 11:33:11 for nRF51822 Beacon Firmware Documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
