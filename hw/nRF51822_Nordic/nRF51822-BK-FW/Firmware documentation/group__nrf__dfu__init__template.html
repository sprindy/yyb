<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>nRF51822 Beacon Firmware Documentation: Template file with an DFU init packet handling example.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF51822 Beacon Firmware Documentation
   &#160;<span id="projectnumber">v1.1.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__nrf__dfu__init__template.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">Template file with an DFU init packet handling example.<div class="ingroups"><a class="el" href="group__nrf__dfu.html">Device Firmware Update API.</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>This file contains a template on how to implement DFU init packet handling.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ga52efd147c1db4e891b5db35a34c9c063"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nrf__dfu__init__template.html#ga52efd147c1db4e891b5db35a34c9c063">DFU_INIT_PACKET_EXT_LENGTH_MIN</a>&#160;&#160;&#160;2</td></tr>
<tr class="separator:ga52efd147c1db4e891b5db35a34c9c063"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga385b3f2468b32170a0d3b82389493053"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nrf__dfu__init__template.html#ga385b3f2468b32170a0d3b82389493053">DFU_INIT_PACKET_EXT_LENGTH_MAX</a>&#160;&#160;&#160;10</td></tr>
<tr class="separator:ga385b3f2468b32170a0d3b82389493053"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga585131c480f3f4e51293e954b4c26aeb"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nrf__dfu__init__template.html#ga585131c480f3f4e51293e954b4c26aeb">dfu_init_prevalidate</a> (uint8_t *p_init_data, uint32_t init_data_len)</td></tr>
<tr class="memdesc:ga585131c480f3f4e51293e954b4c26aeb"><td class="mdescLeft">&#160;</td><td class="mdescRight">DFU prevalidate call for pre-checking the received init packet.  <a href="#ga585131c480f3f4e51293e954b4c26aeb">More...</a><br/></td></tr>
<tr class="separator:ga585131c480f3f4e51293e954b4c26aeb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga1926c2d8e3484641d16f9beb654ac5f1"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nrf__dfu__init__template.html#ga1926c2d8e3484641d16f9beb654ac5f1">dfu_init_postvalidate</a> (uint8_t *p_image, uint32_t image_len)</td></tr>
<tr class="memdesc:ga1926c2d8e3484641d16f9beb654ac5f1"><td class="mdescLeft">&#160;</td><td class="mdescRight">DFU postvalidate call for post-checking the received image using the init packet.  <a href="#ga1926c2d8e3484641d16f9beb654ac5f1">More...</a><br/></td></tr>
<tr class="separator:ga1926c2d8e3484641d16f9beb654ac5f1"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ga37067a2c1578840a558aa2e248f90126"><td class="memItemLeft" align="right" valign="top">static uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nrf__dfu__init__template.html#ga37067a2c1578840a558aa2e248f90126">m_extended_packet</a> [<a class="el" href="group__nrf__dfu__init__template.html#ga385b3f2468b32170a0d3b82389493053">DFU_INIT_PACKET_EXT_LENGTH_MAX</a>]</td></tr>
<tr class="separator:ga37067a2c1578840a558aa2e248f90126"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga2c1f8e631b7782424ca44cdcf78c1c79"><td class="memItemLeft" align="right" valign="top">static uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__nrf__dfu__init__template.html#ga2c1f8e631b7782424ca44cdcf78c1c79">m_extended_packet_length</a></td></tr>
<tr class="separator:ga2c1f8e631b7782424ca44cdcf78c1c79"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>This file contains a template on how to implement DFU init packet handling. </p>
<p>The template shows how device type and revision can be used for a safety check of the received image. It shows how validation can be performed in two stages:</p>
<ul>
<li>Stage 1: Pre-check of firmware image before transfer to ensure the firmware matches:<ul>
<li>Device Type.</li>
<li>Device Revision. Installed SoftDevice. This template can be extended with additional checks according to needs. For example, such a check could be the origin of the image (trusted source) based on a signature scheme.</li>
</ul>
</li>
<li>Stage 2: Post-check of the image after image transfer but before installing firmware. For example, such a check could be an integrity check in form of hashing or verification of a signature. In this template, a simple CRC check is carried out. The CRC check can be replaced with other mechanisms, like signing.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>This module does not support security features such as image signing, but the implementation allows for such extension. If the init packet is signed by a trusted source, it must be decrypted before it can be processed. </dd></dl>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a class="anchor" id="ga52efd147c1db4e891b5db35a34c9c063"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DFU_INIT_PACKET_EXT_LENGTH_MIN&#160;&#160;&#160;2</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="dfu__init__template_8c_source.html#l00050">50</a> of file <a class="el" href="dfu__init__template_8c_source.html">dfu_init_template.c</a>.</p>

</div>
</div>
<a class="anchor" id="ga385b3f2468b32170a0d3b82389493053"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DFU_INIT_PACKET_EXT_LENGTH_MAX&#160;&#160;&#160;10</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="dfu__init__template_8c_source.html#l00051">51</a> of file <a class="el" href="dfu__init__template_8c_source.html">dfu_init_template.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ga585131c480f3f4e51293e954b4c26aeb"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t dfu_init_prevalidate </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>p_init_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>init_data_len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>DFU prevalidate call for pre-checking the received init packet. </p>
<p>Pre-validation will safety check the firmware image to be transfered in second stage. The function currently checks the device type, device revision, application firmware version, and supported SoftDevices. More checks should be added according to customer-specific requirements.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">p_init_data</td><td>Pointer to the init packet. If the init packet is encrypted or signed, it must first be decrypted before being checked. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">init_data_len</td><td>Length of the init data.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">NRF_SUCCESS</td><td>If the pre-validation succeeded, that means the image is supported by the device and it is considered to come from a trusted source (signing). </td></tr>
    <tr><td class="paramname">NRF_ERROR_INVALID_DATA</td><td>If the pre-validation failed, that means the image is not supported by the device or comes from an un-trusted source (signing). </td></tr>
    <tr><td class="paramname">NRF_ERROR_INVALID_LENGTH</td><td>If the size of the init packet is not within the limits of the init packet handler. </td></tr>
  </table>
  </dd>
</dl>
<p>[DFU init application version]</p>
<p>[DFU init application version] </p>

<p>Definition at line <a class="el" href="dfu__init__template_8c_source.html#l00057">57</a> of file <a class="el" href="dfu__init__template_8c_source.html">dfu_init_template.c</a>.</p>

<p>References <a class="el" href="dfu__init_8h_source.html#l00053">dfu_init_packet_t::device_rev</a>, <a class="el" href="dfu__init_8h_source.html#l00052">dfu_init_packet_t::device_type</a>, <a class="el" href="dfu__init_8h_source.html#l00079">DFU_DEVICE_INFO</a>, <a class="el" href="dfu__init_8h_source.html#l00082">DFU_DEVICE_REVISION_EMPTY</a>, <a class="el" href="dfu__init_8h_source.html#l00081">DFU_DEVICE_TYPE_EMPTY</a>, <a class="el" href="dfu__init__template_8c_source.html#l00050">DFU_INIT_PACKET_EXT_LENGTH_MIN</a>, <a class="el" href="dfu__init_8h_source.html#l00083">DFU_SOFTDEVICE_ANY</a>, <a class="el" href="dfu__init__template_8c_source.html#l00053">m_extended_packet</a>, <a class="el" href="dfu__init__template_8c_source.html#l00054">m_extended_packet_length</a>, <a class="el" href="nrf__error_8h_source.html#l00039">NRF_ERROR_INVALID_DATA</a>, <a class="el" href="nrf__error_8h_source.html#l00037">NRF_ERROR_INVALID_LENGTH</a>, <a class="el" href="nrf__error_8h_source.html#l00028">NRF_SUCCESS</a>, <a class="el" href="dfu__init_8h_source.html#l00056">dfu_init_packet_t::softdevice</a>, <a class="el" href="nrf51__beacon_2ble__app__beacon__dfu_2bootloader_2config_2dfu__types_8h_source.html#l00044">SOFTDEVICE_INFORMATION</a>, and <a class="el" href="dfu__init_8h_source.html#l00055">dfu_init_packet_t::softdevice_len</a>.</p>
<div class="fragment"><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;{</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    uint32_t i = 0;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    </div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="comment">// In order to support signing or encryption then any init packet decryption function / library</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="comment">// should be called from here or implemented at this location.</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">// Length check to ensure valid data are parsed.</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keywordflow">if</span> (init_data_len &lt; <span class="keyword">sizeof</span>(<a class="code" href="structdfu__init__packet__t.html" title="Structure contained in an init packet. Contains information on device type, revision, and supported SoftDevices. ">dfu_init_packet_t</a>))</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    {</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="group__nrf__error.html#ga59fe2a8fe184005aefa0835c7ff400fd" title="Invalid Length. ">NRF_ERROR_INVALID_LENGTH</a>;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    }</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <span class="comment">// Current template uses clear text data so they can be casted for pre-check.</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <a class="code" href="structdfu__init__packet__t.html" title="Structure contained in an init packet. Contains information on device type, revision, and supported SoftDevices. ">dfu_init_packet_t</a> * p_init_packet = (<a class="code" href="structdfu__init__packet__t.html" title="Structure contained in an init packet. Contains information on device type, revision, and supported SoftDevices. ">dfu_init_packet_t</a> *)p_init_data;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <a class="code" href="group__nrf__dfu__init__template.html#ga2c1f8e631b7782424ca44cdcf78c1c79">m_extended_packet_length</a> = ((uint32_t)p_init_data + init_data_len) -</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;                               (uint32_t)&amp;p_init_packet-&gt;<a class="code" href="structdfu__init__packet__t.html#a372ef03871f0d72c73b551daf31724e6">softdevice</a>[p_init_packet-&gt;<a class="code" href="structdfu__init__packet__t.html#acc864c4e20a9662810a998117b5a55c6">softdevice_len</a>];</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    if (<a class="code" href="group__nrf__dfu__init__template.html#ga2c1f8e631b7782424ca44cdcf78c1c79">m_extended_packet_length</a> &lt; <a class="code" href="group__nrf__dfu__init__template.html#ga52efd147c1db4e891b5db35a34c9c063">DFU_INIT_PACKET_EXT_LENGTH_MIN</a>)</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    {</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="group__nrf__error.html#ga59fe2a8fe184005aefa0835c7ff400fd" title="Invalid Length. ">NRF_ERROR_INVALID_LENGTH</a>;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    }</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="keywordflow">if</span> (((uint32_t)p_init_data + init_data_len) &lt; </div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        (uint32_t)&amp;p_init_packet-&gt;<a class="code" href="structdfu__init__packet__t.html#a372ef03871f0d72c73b551daf31724e6">softdevice</a>[p_init_packet-&gt;<a class="code" href="structdfu__init__packet__t.html#acc864c4e20a9662810a998117b5a55c6">softdevice_len</a>])</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    {</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="group__nrf__error.html#ga59fe2a8fe184005aefa0835c7ff400fd" title="Invalid Length. ">NRF_ERROR_INVALID_LENGTH</a>;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    }</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    memcpy(<a class="code" href="group__nrf__dfu__init__template.html#ga37067a2c1578840a558aa2e248f90126">m_extended_packet</a>,</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;           &amp;p_init_packet-&gt;<a class="code" href="structdfu__init__packet__t.html#a372ef03871f0d72c73b551daf31724e6">softdevice</a>[p_init_packet-&gt;<a class="code" href="structdfu__init__packet__t.html#acc864c4e20a9662810a998117b5a55c6">softdevice_len</a>],</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;           <a class="code" href="group__nrf__dfu__init__template.html#ga2c1f8e631b7782424ca44cdcf78c1c79">m_extended_packet_length</a>);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="comment">// In order to support application versioning this check should be updated.</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="comment">// This template allows for any application to be installed however customer could place a</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="comment">// revision number at bottom of application to be verified by bootloader. This could be done at</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <span class="comment">// a relative location to this papplication for example Application start address + 0x0100.</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment"></span>    <span class="comment">// First check to verify the image to be transfered matches the device type.</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="comment">// If no Device type is present in DFU_DEVICE_INFO then any image will be accepted.</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="group__nrf__dfu__init.html#ga0739b7c5c51d4dd06d88df8fb562e186">DFU_DEVICE_INFO</a>-&gt;device_type != <a class="code" href="group__nrf__dfu__init.html#gaa80004af35800b51c972eb5441641b02">DFU_DEVICE_TYPE_EMPTY</a>) &amp;&amp;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        (p_init_packet-&gt;<a class="code" href="structdfu__init__packet__t.html#ab82f07863ad1a23a43e2573efe0dac8f">device_type</a> != <a class="code" href="group__nrf__dfu__init.html#ga0739b7c5c51d4dd06d88df8fb562e186">DFU_DEVICE_INFO</a>-&gt;device_type))</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    {</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="group__nrf__error.html#gaca6d57e218563351e7abdbdebb049f69" title="Invalid Data. ">NRF_ERROR_INVALID_DATA</a>;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    }</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    </div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <span class="comment">// Second check to verify the image to be transfered matches the device revision.</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="comment">// If no Device revision is present in DFU_DEVICE_INFO then any image will be accepted.</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="group__nrf__dfu__init.html#ga0739b7c5c51d4dd06d88df8fb562e186">DFU_DEVICE_INFO</a>-&gt;device_rev != <a class="code" href="group__nrf__dfu__init.html#gab5e1b5ab912c1a30149be52c8cea371d">DFU_DEVICE_REVISION_EMPTY</a>) &amp;&amp;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        (p_init_packet-&gt;<a class="code" href="structdfu__init__packet__t.html#a0e47bacb03a8f591e92bcde7f450e909">device_rev</a> != <a class="code" href="group__nrf__dfu__init.html#ga0739b7c5c51d4dd06d88df8fb562e186">DFU_DEVICE_INFO</a>-&gt;device_rev))</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    {</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="group__nrf__error.html#gaca6d57e218563351e7abdbdebb049f69" title="Invalid Data. ">NRF_ERROR_INVALID_DATA</a>;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    }</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="comment">// Third check: Check the array of supported SoftDevices by this application.</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="comment">//              If the installed SoftDevice does not match any SoftDevice in the list then an</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="comment">//              error is returned.</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="keywordflow">while</span> (i &lt; p_init_packet-&gt;softdevice_len)</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    {</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        <span class="keywordflow">if</span> (p_init_packet-&gt;<a class="code" href="structdfu__init__packet__t.html#a372ef03871f0d72c73b551daf31724e6">softdevice</a>[i] == <a class="code" href="group__nrf__dfu__init.html#ga963498faf6af23086555c594504b4152">DFU_SOFTDEVICE_ANY</a> ||</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            p_init_packet-&gt;<a class="code" href="structdfu__init__packet__t.html#a372ef03871f0d72c73b551daf31724e6">softdevice</a>[i++] == <a class="code" href="group__nrf__dfu__types.html#gaab39eb82cd517f5d6b50d7b2df9c1929">SOFTDEVICE_INFORMATION</a>-&gt;firmware_id)</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        {</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        }</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    }</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    </div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="comment">// No matching SoftDevice found - Return NRF_ERROR_INVALID_DATA.</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="group__nrf__error.html#gaca6d57e218563351e7abdbdebb049f69" title="Invalid Data. ">NRF_ERROR_INVALID_DATA</a>;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ga1926c2d8e3484641d16f9beb654ac5f1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t dfu_init_postvalidate </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>p_image</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>image_len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>DFU postvalidate call for post-checking the received image using the init packet. </p>
<p>Post-validation can verify the integrity check the firmware image received before activating the image. Checks performed can be:</p>
<ul>
<li>A simple CRC as shown in the corresponding implementation of this API in the file <a class="el" href="dfu__init__template_8c.html">dfu_init_template.c</a></li>
<li>A hash for better verification of the image.</li>
<li>A signature to ensure the image originates from a trusted source. Checks are intended to be expanded for customer-specific requirements.</li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">p_image</td><td>Pointer to the received image. The init data provided in the call <a class="el" href="group__nrf__dfu__init__template.html#ga585131c480f3f4e51293e954b4c26aeb">dfu_init_prevalidate</a> will be used for validating the image. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">image_len</td><td>Length of the image data.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">NRF_SUCCESS</td><td>If the post-validation succeeded, that meant the integrity of the image has been verified and the image originates from a trusted source (signing). </td></tr>
    <tr><td class="paramname">NRF_ERROR_INVALID_DATA</td><td>If the post-validation failed, that meant the post check of the image failed such as the CRC is not matching the image transfered or the verification of the image fails (signing). </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="dfu__init__template_8c_source.html#l00130">130</a> of file <a class="el" href="dfu__init__template_8c_source.html">dfu_init_template.c</a>.</p>

<p>References <a class="el" href="dfu__init__template_8c_source.html#l00053">m_extended_packet</a>, <a class="el" href="nrf__error_8h_source.html#l00039">NRF_ERROR_INVALID_DATA</a>, and <a class="el" href="nrf__error_8h_source.html#l00028">NRF_SUCCESS</a>.</p>
<div class="fragment"><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;{</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    uint16_t image_crc;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    uint16_t received_crc;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    </div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="comment">// In order to support hashing (and signing) then the (decrypted) hash should be fetched and</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <span class="comment">// the corresponding hash should be calculated over the image at this location.</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <span class="comment">// If hashing (or signing) is added to the system then the CRC validation should be removed.</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="comment">// calculate CRC from active block.</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    image_crc = crc16_compute(p_image, image_len, NULL);</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <span class="comment">// Decode the received CRC from extended data.    </span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    received_crc = uint16_decode((uint8_t *)&amp;<a class="code" href="group__nrf__dfu__init__template.html#ga37067a2c1578840a558aa2e248f90126">m_extended_packet</a>[0]);</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="comment">// Compare the received and calculated CRC.</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordflow">if</span> (image_crc != received_crc)</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    {</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="group__nrf__error.html#gaca6d57e218563351e7abdbdebb049f69" title="Invalid Data. ">NRF_ERROR_INVALID_DATA</a>;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    }</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="group__nrf__error.html#ga7e6367efeaac363d8cf024940b4ec123" title="Successful command. ">NRF_SUCCESS</a>;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a class="anchor" id="ga37067a2c1578840a558aa2e248f90126"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t m_extended_packet[<a class="el" href="group__nrf__dfu__init__template.html#ga385b3f2468b32170a0d3b82389493053">DFU_INIT_PACKET_EXT_LENGTH_MAX</a>]</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="dfu__init__template_8c_source.html#l00053">53</a> of file <a class="el" href="dfu__init__template_8c_source.html">dfu_init_template.c</a>.</p>

</div>
</div>
<a class="anchor" id="ga2c1f8e631b7782424ca44cdcf78c1c79"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t m_extended_packet_length</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="dfu__init__template_8c_source.html#l00054">54</a> of file <a class="el" href="dfu__init__template_8c_source.html">dfu_init_template.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Apr 13 2015 11:33:11 for nRF51822 Beacon Firmware Documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
